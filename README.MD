# ğŸ“š TÃ i liá»‡u Chi Tiáº¿t â€” Luá»“ng gá»i hÃ m khi Thanh toÃ¡n báº±ng CRYPTO

Má»¥c tiÃªu cá»§a tÃ i liá»‡u nÃ y lÃ  mÃ´ táº£ theo thá»© tá»± cÃ¡c hÃ m (frontend â†’ backend â†’ dá»‹ch vá»¥ â†’ DB â†’ blockchain) Ä‘Æ°á»£c gá»i khi
ngÆ°á»i dÃ¹ng báº¥m nÃºt "Thanh toÃ¡n" báº±ng phÆ°Æ¡ng thá»©c CRYPTO trÃªn trang Checkout (nhiá»u sáº£n pháº©m) hoáº·c nÃºt "Buy with Crypto" trÃªn trang Product (má»™t sáº£n pháº©m).

TÃ i liá»‡u táº­p trung vÃ o luá»“ng gá»i hÃ m thá»±c táº¿ â€” tÃªn hÃ m, file tham chiáº¿u, vÃ  mÃ´ táº£ ngáº¯n vá» nhiá»‡m vá»¥ cá»§a tá»«ng hÃ m theo trÃ¬nh tá»± thá»±c thi.

LÆ°u Ã½: tÃªn hÃ m vÃ  Ä‘Æ°á»ng dáº«n dá»±a trÃªn cáº¥u trÃºc hiá»‡n táº¡i cá»§a dá»± Ã¡n. Náº¿u báº¡n Ä‘á»•i tÃªn file/hÃ m trong repo, hÃ£y Ä‘á»‘i chiáº¿u láº¡i.

---

## TÃ³m táº¯t luá»“ng cao cáº¥p

1. Frontend: ngÆ°á»i dÃ¹ng chá»n `CRYPTO` vÃ  báº¥m nÃºt thanh toÃ¡n â†’ frontend xá»­ lÃ½ MetaMask, kÃ½ vÃ  gá»­i giao dá»‹ch.
2. Frontend nháº­n `transactionHash` â†’ gá»i API backend `POST /api/confirm-crypto-payment` (hoáº·c tÆ°Æ¡ng tá»±) kÃ¨m payload gá»“m `cartItems`, `vndAmount`, `transactionHash`, `fromAddress`, `amount`, `currency`.
3. Backend: xÃ¡c thá»±c user, xÃ¡c minh giao dá»‹ch trÃªn blockchain (Web3), táº¡o Order/OrderDetail, lÆ°u CryptoTransaction, cáº­p nháº­t kho vÃ  tráº£ vá» káº¿t quáº£.

---

## Luá»“ng chi tiáº¿t theo thá»© tá»± hÃ m (CRYPTO Checkout - nhiá»u sáº£n pháº©m)

Sau Ä‘Ã¢y lÃ  sequence cÃ¡c hÃ m (frontend â†’ server) â€” tá»« khi báº¥m nÃºt CRYPTO cho tá»›i khi order Ä‘Æ°á»£c táº¡o vÃ  lÆ°u transaction:

1) Frontend: form submit / button handler
  - Vá»‹ trÃ­: `public/client/js/...` hoáº·c trong template `checkout.ejs`
  - HÃ m/handler: (tÃ¹y implementation) thÆ°á»ng lÃ  sá»± kiá»‡n `submit` trÃªn form hoáº·c `click` handler cho nÃºt `#btnCheckoutPay` khi `paymentMethod === 'CRYPTO'`.
  - Nhiá»‡m vá»¥: ngÄƒn form gá»­i máº·c Ä‘á»‹nh, kiá»ƒm tra MetaMask/Wallet tráº¡ng thÃ¡i, gá»i routine thanh toÃ¡n crypto.

2) Frontend: init wallet & request accounts
  - File: `public/client/js/crypto-payment.js`
  - HÃ m: `initWeb3()`
  - Nhiá»‡m vá»¥: phÃ¡t hiá»‡n MetaMask (window.ethereum), táº¡o `web3` instance, gá»i `ethereum.request({ method: 'eth_requestAccounts' })` hoáº·c `web3.eth.getAccounts()` Ä‘á»ƒ láº¥y `fromAddress` (user wallet). Náº¿u khÃ´ng cÃ³ MetaMask, hiá»ƒn thá»‹ modal cÃ i Ä‘áº·t.

3) Frontend: convert and display crypto amount (UX)
  - File: `public/client/js/crypto-payment.js` & view templates (`cart.ejs`, `checkout.ejs`)
  - HÃ m: `convertVNDtoSGB()` (client helper) â€” tÃ¹y tÃªn á»Ÿ file client
  - Nhiá»‡m vá»¥: chuyá»ƒn `vndAmount` sang token amount theo `cryptoRate` (show cho user trÆ°á»›c khi kÃ½ tx).

4) Frontend: prepare & send transaction via Web3/MetaMask
  - File: `public/client/js/crypto-payment.js`
  - HÃ m: `sendCryptoPayment()` (hoáº·c inline handler) â€” sá»­ dá»¥ng `web3.eth.sendTransaction` hoáº·c gá»i contract `transfer(...)` náº¿u ERC20
  - Nhiá»‡m vá»¥: build transaction (to = adminWallet, value hoáº·c token transfer), gá»i `ethereum.request({ method: 'eth_sendTransaction', params: [...] })` hoáº·c `web3.eth.sendSignedTransaction(...)` náº¿u cÃ³ signature
  - Káº¿t quáº£: tráº£ vá» `transactionHash` khi giao dá»‹ch Ä‘Æ°á»£c broadcast (thÆ°á»ng trÆ°á»›c khi mined).

5) Frontend: POST confirm request to backend
  - Endpoint: `POST /api/confirm-crypto-payment` (the doc and routes indicate this endpoint)
  - Payload: {
     cartItems, vndAmount, transactionHash, amount (token), currency (SGB/ETH), fromAddress, receiverName, receiverPhone, receiverAddress, ...
    }
  - HÃ m: `confirmCryptoPaymentClient()` (in client script) or direct XHR/fetch call

6) Backend controller: receive confirm request
  - File: `src/controllers/crypto-payment.controller.ts` (or similar; doc refers to `crypto-payment.controller.ts`)
  - Handler function: `confirmCryptoPayment(req, res)`
  - Nhiá»‡m vá»¥:
    - Láº¥y user (req.user) â€” kiá»ƒm tra authentication
    - Parse payload: `transactionHash`, `cartItems`, `vndAmount`, `fromAddress`, `amount`, `currency`.

7) Backend service: verify transaction on blockchain
  - File: a service using Web3 (could be in `services/crypto` or an on-chain helper)
  - HÃ m: `verifyTransaction(transactionHash, expectedToAddress, expectedAmount, network)`
  - Nhiá»‡m vá»¥: sá»­ dá»¥ng `web3.eth.getTransaction` / `web3.eth.getTransactionReceipt` Ä‘á»ƒ
    - Check the transaction exists
    - Ensure `to` matches admin wallet
    - Ensure `value` or token transfer amount >= expected token amount
    - Optionally check confirmations or receipt.status === true
  - Náº¿u verification fail â†’ return 4xx with message (frontend should show error)

8) Backend: fetch active crypto metadata and admin wallet
  - File / functions referenced in repo:
    - `getActiveCryptoInfo()` â€” returns `{ priceVND, decimals, code, ... }` (in `src/services/crypto/crypto.service.ts`)
    - `getAdminWallet()` â€” returns admin receiving address (either from DB CryptoWallet or fallback `ADMIN_WALLET_ADDRESS` env)
  - Nhiá»‡m vá»¥: ensure we used the right token (SGB) and the admin wallet matches expected receiver

9) Backend: create Order (within DB transaction)
  - File: likely within `src/services/client/order.service.ts` or inside `confirmCryptoPayment` controller using prisma
  - HÃ m: `createOrderForCrypto(userId, cartItems, totalVnd, paymentRef, receiverInfo)` (conceptual)
  - Nhiá»‡m vá»¥:
    - Create `Order` record with fields: `userId`, `totalPrice: vndAmount`, `paymentMethod: 'CRYPTO'`, `paymentStatus: 'PAID'`, `paymentRef: transactionHash`, `statusOrder: 'PENDING'` (or `COMPLETED` for single-product flow)

10) Backend: record CryptoTransaction
   - Model: `CryptoTransaction` (Prisma model) â€” see schema in repo
   - HÃ m: `createCryptoTransaction({ transactionHash, fromAddress, toAddress, amount, amountInFiat, status, orderId, cryptoId })`
   - Nhiá»‡m vá»¥: persist blockchain record for auditing/reporting

11) Backend: create OrderDetails and update stock
   - For each cart item:
    - Determine variant and final price (product.price + variant.priceMore)
    - Create `OrderDetail` row
    - Update `ProductVariant` quantity & `sold`
    - Update `Product` quantity & `sold`
    - Remove cartdetail row from user's cart
   - These updates should be performed inside the same DB transaction when possible to avoid inconsistencies

12) Backend: commit transaction and respond
   - Return `{ success: true, orderId: newOrder.id }` (or error). Frontend will display success and redirect to order history

13) Frontend: post-confirm handling
   - On success, frontend shows confirmation and redirects user to orders list / detail page
   - On failure, show error and allow retry

---

## CÃ¡c hÃ m/Ä‘Æ¡n vá»‹ chÃ­nh (táº­p trung) â€” mapping tÃªn thá»±c táº¿ trong repo

- `initWeb3()` â€” front-end helper to detect MetaMask and obtain accounts (`public/client/js/crypto-payment.js`).
- `convertVNDtoSGB(vndAmount)` â€” front-end helper show estimated token amount (client UI conversion).
- `sendCryptoPayment()` / `sendTransaction()` â€” front-end routine that calls MetaMask / web3 to broadcast the transaction and returns `transactionHash`.
- `POST /api/confirm-crypto-payment` â†’ `confirmCryptoPayment(req, res)` â€” backend controller that coordinates verification and order creation (`src/controllers/crypto-payment.controller.ts` or equivalent).
- `verifyTransaction(transactionHash, expectedTo, expectedAmount)` â€” backend web3 helper to inspect on-chain tx and receipt.
- `getAdminWallet()` â€” returns active admin wallet (`src/controllers/crypto-payment.controller.ts` or `src/services/crypto/...`).
- `getActiveCryptoInfo()` â€” returns active `Cryptocurrency` row (priceVND, decimals, code).
- `convertVndToCrypto(amountVND, priceVND, decimals, displayDecimals)` â€” server-side helper to convert VND -> crypto (used to populate cart/checkout views consistently).
- `createOrderForCrypto(...)` (conceptual) â€” service that creates Order and OrderDetails, updates stock, and returns created `orderId`.
- `createCryptoTransaction(...)` â€” service inserting `CryptoTransaction` record in DB.
- `CancelOrderById(orderId, user)` â€” service that may attempt refunds (if order.paymentMethod === 'CRYPTO') and now returns a detailed refund result object.

### MetaMask / Web3 Call Sites (repo mapping)

DÆ°á»›i Ä‘Ã¢y lÃ  nhá»¯ng nÆ¡i trong repo trá»±c tiáº¿p gá»i MetaMask / provider (window.ethereum) hoáº·c dÃ¹ng Web3 Ä‘á»ƒ gá»­i/gá»i giao dá»‹ch, cÃ¹ng Ä‘oáº¡n mÃ£ trÃ­ch dáº«n Ä‘á»ƒ báº¡n dá»… tham kháº£o vÃ  copy/paste.

- File: `public/client/js/crypto-payment.js`
  - `checkAndInstallMetaMask()` â€” hiá»ƒn thá»‹ modal cÃ i MetaMask náº¿u khÃ´ng cÃ³.
  - `initWeb3()` â€” táº¡o `web3` tá»« `window.ethereum`, gá»i `eth_requestAccounts`, láº¥y `userAccount`, vÃ  gá»i `wallet_switchEthereumChain` Ä‘á»ƒ chuyá»ƒn sang Coston.
    ```js
    web3 = new Web3(window.ethereum);
    await window.ethereum.request({ method: 'eth_requestAccounts' });
    const accounts = await web3.eth.getAccounts();
    userAccount = accounts[0];
    await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: '0x10' }] });
    ```

  - `convertVNDtoSGB(vndAmount)` â€” helper chuyá»ƒn VND -> SGB (client-side display):
    ```js
    function convertVNDtoSGB(vndAmount) {
        return (parseInt(vndAmount) / VND_TO_SGB_RATE).toFixed(6);
    }
    ```

  - `showCryptoPaymentModal(options)` â€” dá»±ng modal thanh toÃ¡n, attach event listener cho nÃºt xÃ¡c nháº­n, truyá»n `adminWallet`, `weiValue`, `cartItems`, v.v.

  - `confirmCheckoutCryptoPayment(adminAddress, weiValue, vndAmount, ...)` â€” hÃ m chÃ­nh gá»­i tx vÃ  confirm vá»›i server. Gá»­i giao dá»‹ch qua MetaMask báº±ng `eth_sendTransaction`:
    ```js
    const params = [{ from: userAccount, to: adminAddress, value: web3.utils.toHex(weiValue) }];
    txHash = await window.ethereum.request({ method: 'eth_sendTransaction', params });
    // fallback:
    const receipt = await web3.eth.sendTransaction({ from: userAccount, to: adminAddress, value: weiValue });
    txHash = receipt && (receipt.transactionHash || receipt);
    ```

  - Sau khi cÃ³ `txHash`, hÃ m gá»i API xÃ¡c nháº­n vá»›i server (vÃ­ dá»¥ `/api/crypto/confirm-payment`):
    ```js
    await fetch('/api/crypto/confirm-payment', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ transactionHash: txHash, amount: ..., fromAddress: userAccount, vndAmount: ... })
    });
    ```

- File: `src/views/client/product/payment-section.ejs` and `src/views/client/product/checkout.ejs`
  - Template may include inlined calls to the client scripts and use data-attributes to pass `TotalPrice`, `cryptoRate`, etc. The client JS reads these attributes to compute `priceInSGB`.

- Routes / Server handlers that client calls:
  - `GET /api/get-admin-wallet` â†’ `getAdminWallet` (server) â€” File: `src/controllers/ClientAPI/crypto-payment.controller.ts`.
    ```ts
    const activeWalletRecord = await prisma.cryptoWallet.findFirst({ where: { isActive: true } });
    const adminWallet = activeWalletRecord?.walletAddress || process.env.ADMIN_WALLET_ADDRESS;
    res.json({ adminWallet });
    ```

  - `POST /api/crypto/confirm-payment` and `POST /api/orders/confirm-crypto-payment` â†’ `confirmCryptoPayment` (server) â€” same controller `src/controllers/ClientAPI/crypto-payment.controller.ts`.

    Important: current implementation in the controller records the crypto transaction and creates orders immediately without calling a server-side on-chain verification helper. Recommended improvement is to add `verifyTransaction(transactionHash, expectedTo, expectedAmount)` (server-side Web3) BEFORE creating the Order.

### Recommended server-side verifyTransaction (example)

Add a server helper (e.g., `src/services/crypto/onchain.service.ts`) to verify tx on-chain before persisting the order. Example conceptual code:

```js
// pseudo-code
async function verifyTransaction(web3, txHash, expectedTo, expectedWei) {
  const tx = await web3.eth.getTransaction(txHash);
  if (!tx) throw new Error('Transaction not found');
  if ((tx.to || '').toLowerCase() !== expectedTo.toLowerCase()) throw new Error('Recipient mismatch');
  // if native tx: compare tx.value (hex) with expectedWei
  // for token transfers, parse logs or call getTransactionReceipt and inspect logs
  const receipt = await web3.eth.getTransactionReceipt(txHash);
  if (!receipt || receipt.status !== true) throw new Error('Transaction not successful');
  return { tx, receipt };
}
```

Báº¡n cÃ³ thá»ƒ gá»i helper nÃ y at the top of `confirmCryptoPayment` and only proceed to create the Order when verification passes.

---
---

## HoÃ n tiá»n (Refund) â€” gá»i hÃ m theo thá»© tá»±

Khi admin hoáº·c user trigger cancel-order cho Ä‘Æ¡n Ä‘Ã£ thanh toÃ¡n báº±ng crypto, sequence hÃ m thÆ°á»ng lÃ :

1. Controller endpoint: `POST /api/cancel-order/:id` â†’ handler `PostCancelOrder(req, res)` in `src/controllers/client/client.controller.ts`
2. Service: `CancelOrderById(orderId, user)` (in `src/services/client/user.service.ts`)
  - TrÆ°á»›c háº¿t xÃ¡c Ä‘á»‹nh `order.paymentMethod` vÃ  `order.paymentStatus`.
3. Náº¿u `paymentMethod === 'CRYPTO'` vÃ  tráº¡ng thÃ¡i phÃ¹ há»£p â†’ tÃ¬m `CryptoTransaction` gá»‘c liÃªn quan.
4. TÃ¬m admin active wallet / private key (`getAdminWallet()` / `getActiveAdminWalletWithPrivateKey()`)
5. KÃ½ tx hoÃ n tiá»n vÃ  gá»­i lÃªn máº¡ng (Web3) â†’ `sendSignedTransaction(signedTx)` (thá»±c hiá»‡n hoÃ n tiá»n on-chain)
6. Ghi má»™t báº£n `CryptoTransaction` má»›i cho refund, cáº­p nháº­t `CryptoTransaction` gá»‘c tráº¡ng thÃ¡i `REFUNDED`, vÃ  cáº­p nháº­t `Order` (`statusOrder = 'CANCELLED'`, `paymentStatus = 'REFUNDED'`).
7. Tráº£ vá» object chi tiáº¿t: `{ attempted: true|false, method: 'CRYPTO'|null, success: boolean, txHash?: string, message?: string }`.

---

## LÆ°u Ã½ váº­n hÃ nh vÃ  kiá»ƒm tra

- LuÃ´n verify on-chain: kiá»ƒm tra `to` address === admin wallet, `amount` >= expected.
- Giá»¯ Ä‘á»‹nh dáº¡ng `amount` token dÆ°á»›i dáº¡ng `string` Ä‘á»ƒ trÃ¡nh máº¥t precision.
- Thá»±c hiá»‡n cÃ¡c thao tÃ¡c táº¡o Ä‘Æ¡n/ghi transaction/update stock trong cÃ¹ng transaction DB khi cÃ³ thá»ƒ.
- KhÃ´ng lÆ°u private key plaintext trong repo/DB production. DÃ¹ng KMS / Vault.

---

Náº¿u báº¡n muá»‘n, tÃ´i cÃ³ thá»ƒ:
- Liá»‡t kÃª chÃ­nh xÃ¡c tÃªn hÃ m trong tá»«ng file (scan repo vÃ  táº¡o mapping chÃ­nh xÃ¡c), hoáº·c
- Cháº¡y search Ä‘á»ƒ chÃ¨n Ä‘Æ°á»ng dáº«n file vÃ  tÃªn hÃ m chÃ­nh xÃ¡c vÃ o má»i bÆ°á»›c Ä‘á»ƒ tÃ i liá»‡u trá»Ÿ nÃªn â€œclickableâ€ (vá»›i Ä‘Æ°á»ng dáº«n file).

Báº¡n muá»‘n tÃ´i tiáº¿p tá»¥c vÃ  tá»± Ä‘á»™ng map má»i hÃ m thá»±c táº¿ trong repo (tÃªn file + hÃ m)?
|-------|--------|--------|
| `statusOrder` | PENDING | Äang chá» xÃ¡c nháº­n tá»« admin |
| `paymentStatus` | PAID | Thanh toÃ¡n Ä‘Ã£ xong (crypto Ä‘Ã£ gá»­i) |
| `paymentRef` | transactionHash | Tham chiáº¿u blockchain |
| `totalPrice` | Tá»•ng VND | Äá»ƒ tÃ­nh chi phÃ­ logistics, bÃ¡o cÃ¡o |

**2.2 LÆ°u CryptoTransaction (blockchain record):**
```typescript
await prisma.cryptoTransaction.create({
  data: {
    transactionHash: transactionHash,         // Hash tá»« blockchain
    fromAddress: req.body.fromAddress,        // Wallet khÃ¡ch hÃ ng
    toAddress: toAddress,                     // Wallet admin
    amount: String(amount),                   // Sá»‘ token (chuá»—i Ä‘á»ƒ trÃ¡nh máº¥t chÃ­nh xÃ¡c)
    amountInFiat: Number(vndAmount),          // GiÃ¡ VND
    status: 'SUCCESS',                        // Giao dá»‹ch thÃ nh cÃ´ng
    description: `Payment for order ${newOrder.id}`,
    orderId: newOrder.id,
    cryptoId: cryptoRecord.id                 // Loáº¡i token
  }
});
```

| Field | GiÃ¡ trá»‹ | Ã nghÄ©a |
|-------|--------|--------|
| `status` | SUCCESS | Giao dá»‹ch blockchain thÃ nh cÃ´ng |
| `cryptoId` | ID token | Link Ä‘áº¿n báº£ng Cryptocurrency |
| `fromAddress` | User wallet | Äá»‹a chá»‰ khÃ¡ch hÃ ng |
| `toAddress` | Admin wallet | Äá»‹a chá»‰ nháº­n tiá»n |

**2.3 Xá»­ lÃ½ tá»«ng item trong giá» hÃ ng:**
```typescript
for (const item of cartItems) {
  // A. Láº¥y thÃ´ng tin cart detail tá»« DB
  const cartItem = await prisma.cartdetail.findUnique({
    where: { id: parseInt(item.id) }
  });
  
  // B. Láº¥y thÃ´ng tin variant (kiá»ƒm tra tá»« request hoáº·c DB)
  let variantId = parseInt(item.productVariantId);
  if (isNaN(variantId)) variantId = cartItem.productVariantId;
  
  const productVariant = await prisma.productVariant.findUnique({
    where: { id: variantId }
  });
  
  // C. XÃ¡c Ä‘á»‹nh productId
  const productId = productVariant?.productId || cartItem.productId;
  const product = await prisma.product.findUnique({
    where: { id: productId }
  });
  
  // D. TÃ­nh giÃ¡ cuá»‘i cÃ¹ng
  const finalPrice = product.price + (productVariant?.priceMore || 0);
  
  // E. Táº¡o OrderDetail
  await prisma.orderDetail.create({
    data: {
      orderId: newOrder.id,
      productId: product.id,
      productVariantId: productVariant.id,
      quantity: cartItem.quantityProduct || 1,
      price: finalPrice                        // GiÃ¡ = base + variant
    }
  });
  
  // F. Cáº­p nháº­t stock variant
  if (productVariant) {
    await prisma.productVariant.update({
      where: { id: productVariant.id },
      data: {
        quantity: { decrement: cartItem.quantityProduct },
        sold: { increment: cartItem.quantityProduct }
      }
    });
  }
  
  // G. Cáº­p nháº­t stock product
  await prisma.product.update({
    where: { id: product.id },
    data: {
      quantity: { decrement: cartItem.quantityProduct },
      sold: { increment: cartItem.quantityProduct }
    }
  });
  
  // H. Cáº­p nháº­t giá» hÃ ng
  await prisma.cart.update({
    where: { id: cartItem.cartId },
    data: {
      quantity: { decrement: cartItem.quantityProduct }
    }
  });
  
  // I. XÃ³a khá»i cart detail
  await prisma.cartdetail.delete({
    where: { id: cartItem.id }
  });
}
```

**2.4 Return response:**
```json
{
  "success": true,
  "orderId": 123
}
```

##### **Step 3: Xá»­ lÃ½ Single Product**
```typescript
if (productId)
```

TÆ°Æ¡ng tá»± nhÆ° trÃªn nhÆ°ng:
- Chá»‰ láº¥y 1 product
- `statusOrder` = `COMPLETED` (khÃ´ng cáº§n duyá»‡t)
- Chá»‰ táº¡o 1 OrderDetail
- Láº¥y thÃ´ng tin user máº·c Ä‘á»‹nh náº¿u receiver info trá»‘ng

---

### ğŸ“ File: `eth-payment.controller.ts`

#### **HÃ m: `confirmEthPayment()`**
```typescript
export const confirmEthPayment = async (req: Request, res: Response)
```

**Má»¥c Ä‘Ã­ch:** XÃ¡c nháº­n thanh toÃ¡n Ethereum (khÃ´ng cÃ²n sá»­ dá»¥ng, giá»¯ cho tÆ°Æ¡ng thÃ­ch ngÆ°á»£c)

**Tham sá»‘:**
```typescript
{
  productId: number,
  transactionHash: string,
  blockNumber: number,
  ethAmount: string
}
```

**Quy trÃ¬nh:**
```
1. Verify transaction on blockchain using Web3.js
   â””â”€ web3.eth.getTransaction(transactionHash)
2. Check náº¿u transaction khÃ´ng tá»“n táº¡i â†’ Return 400 error
3. Láº¥y ETH price (hardcoded = 2000 USD)
4. Táº¡o Order vá»›i thÃ´ng tin:
   - totalPrice = ethAmount * ethPrice
   - paymentMethod = 'ETH'
   - LÆ°u txHash, ethAmount, ethPrice, blockNumber
5. Create OrderDetail
6. Update product stock
7. Return success + orderId
```

---

## ğŸ“Š Database Models

### **Model: CryptoTransaction**
```prisma
model CryptoTransaction {
  id              Int       @id @default(autoincrement())
  transactionHash String    @unique
  fromAddress     String    // Wallet khÃ¡ch hÃ ng
  toAddress       String    // Wallet admin
  amount          String    // Sá»‘ token (string Ä‘á»ƒ trÃ¡nh máº¥t Ä‘á»™ chÃ­nh xÃ¡c)
  amountInFiat    Float     // GiÃ¡ tÃ­nh báº±ng VND/USD
  status          String    // SUCCESS, FAILED, PENDING, REFUNDED
  description     String?
  
  order           Order?    @relation(fields: [orderId], references: [id])
  orderId         Int?
  
  crypto          Cryptocurrency @relation(fields: [cryptoId], references: [id])
  cryptoId        Int
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}
```

| Field | Kiá»ƒu | Ã nghÄ©a |
|-------|------|--------|
| `transactionHash` | String | Hash giao dá»‹ch blockchain (duy nháº¥t) |
| `fromAddress` | String | Äá»‹a chá»‰ gá»­i (khÃ¡ch hÃ ng) |
| `toAddress` | String | Äá»‹a chá»‰ nháº­n (admin) |
| `amount` | String | Sá»‘ token gá»­i (string Ä‘á»ƒ trÃ¡nh float máº¥t chÃ­nh xÃ¡c) |
| `amountInFiat` | Float | GiÃ¡ tÃ­nh báº±ng tiá»n tá»‡ thá»±c |
| `status` | String | `SUCCESS` / `FAILED` / `PENDING` / `REFUNDED` |
| `orderId` | Int | Link Ä‘áº¿n Order |
| `cryptoId` | Int | Link Ä‘áº¿n Cryptocurrency |

**Statuses:**
- `SUCCESS`: Giao dá»‹ch thÃ nh cÃ´ng (lÆ°u khi táº¡o order thÃ nh cÃ´ng)
- `REFUNDED`: HoÃ n tiá»n (lÆ°u khi admin hoÃ n láº¡i tiá»n)
- `PENDING`: Äang chá» xÃ¡c nháº­n (ráº¥t hiáº¿m)
- `FAILED`: Giao dá»‹ch tháº¥t báº¡i

### **Model: Cryptocurrency**
```prisma
model Cryptocurrency {
  id              Int       @id @default(autoincrement())
  name            String    @unique   // Bitcoin, Ethereum, Songbird
  code            String    @unique   // BTC, ETH, SGB
  symbol          String              // à¸¿, Î, âš¡
  priceVND        Float               // GiÃ¡ VND (1 token = ?)
  chainName       String              // Bitcoin, Ethereum, Flare Coston
  rpcUrl          String              // RPC endpoint
  chainId         String              // 0x10 for Coston
  contractAddress String?             // Token contract (náº¿u lÃ  ERC-20)
  decimals        Int       @default(18)
  isActive        Boolean   @default(false)  // Token nÃ o Ä‘Æ°á»£c enable
  description     String?
  
  cryptoTransactions CryptoTransaction[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}
```

### **Model: CryptoWallet**
```prisma
model CryptoWallet {
  id              Int       @id @default(autoincrement())
  walletAddress   String    @unique   // 0x...
  privateKey      String              // Private key (áº£nh Ä‘Æ°á»£c mÃ£ hÃ³a trong production)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}
```

---

## ğŸ“ˆ Luá»“ng Dá»¯ liá»‡u

### **1. KhÃ¡ch hÃ ng gá»­i tiá»n crypto**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Frontend (React/Vue)                                        â”‚
â”‚ 1. Get admin wallet: GET /api/admin-wallet                 â”‚
â”‚ 2. Show MetaMask modal                                      â”‚
â”‚ 3. User signs transaction                                  â”‚
â”‚ 4. POST /api/confirm-crypto-payment                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Blockchain (Ethereum/Flare/etc)                             â”‚
â”‚ 1. Transaction: Customer â†’ Admin                           â”‚
â”‚ 2. Generate transactionHash                                â”‚
â”‚ 3. Mined in block                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Backend (Node.js)                                           â”‚
â”‚ 1. confirmCryptoPayment() nháº­n request                     â”‚
â”‚ 2. Verify transaction on blockchain                        â”‚
â”‚ 3. Create Order (statusOrder: PENDING, paymentStatus: PAID)â”‚
â”‚ 4. Create OrderDetails (tá»«ng sáº£n pháº©m)                    â”‚
â”‚ 5. Create CryptoTransaction (lÆ°u blockchain record)        â”‚
â”‚ 6. Update stock (Product + ProductVariant)                 â”‚
â”‚ 7. Clear cart (delete cartdetails)                         â”‚
â”‚ 8. Return { success: true, orderId }                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Database (MySQL)                                            â”‚
â”‚ Tables Updated:                                             â”‚
â”‚ â”œâ”€ Order (new row)                                         â”‚
â”‚ â”œâ”€ OrderDetail (new rows for each item)                    â”‚
â”‚ â”œâ”€ CryptoTransaction (new row)                             â”‚
â”‚ â”œâ”€ Product (quantity -, sold +)                            â”‚
â”‚ â”œâ”€ ProductVariant (quantity -, sold +)                     â”‚
â”‚ â””â”€ cartdetail (deleted rows)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **2. Database Relationships**

```
User (1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (N) Order
           â”œâ”€ id          â”œâ”€ userId
           â””â”€ email       â””â”€ totalPrice

Order (1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (N) OrderDetail
  â”œâ”€ id                    â”œâ”€ orderId
  â””â”€ paymentRef            â”œâ”€ productId
                           â””â”€ productVariantId

Order (1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (N) CryptoTransaction
  â””â”€ id                    â”œâ”€ orderId
                           â”œâ”€ transactionHash
                           â””â”€ fromAddress

CryptoTransaction (N) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (1) Cryptocurrency
  â””â”€ cryptoId                      â””â”€ id

Product (1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ (N) ProductVariant
   â”œâ”€ id                    â”œâ”€ productId
   â”œâ”€ price                 â”œâ”€ priceMore (thÃªm vÃ o price)
   â””â”€ quantity              â””â”€ quantity
```

---

## ğŸ’° Xá»­ lÃ½ Refund

### **Quy trÃ¬nh HoÃ n tiá»n (tÃ³m táº¯t):**

**File:** `src/services/client/user.service.ts`

Dá»‹ch vá»¥ `CancelOrderById` chá»‰ cá»‘ gáº¯ng thá»±c hiá»‡n hoÃ n tiá»n khi phÃ¹ há»£p (chá»§ yáº¿u cho cÃ¡c Ä‘Æ¡n thanh toÃ¡n báº±ng crypto). CÃ¡c Ä‘iá»ƒm chÃ­nh:

- Chá»‰ thá»±c hiá»‡n hoÃ n tiá»n khi `order.paymentMethod === 'CRYPTO'` vÃ  `order.paymentStatus` lÃ  `PAID` hoáº·c `PAYMENT_PAID`.
- HÃ m giá» tráº£ vá» má»™t Ä‘á»‘i tÆ°á»£ng káº¿t quáº£ hoÃ n tiá»n cÃ³ cáº¥u trÃºc (thay vÃ¬ boolean). Äá»‘i tÆ°á»£ng nÃ y bao gá»“m cÃ¡c trÆ°á»ng nhÆ° `attempted` (Ä‘Ã£ cá»‘ gáº¯ng hay chÆ°a), `method` (phÆ°Æ¡ng thá»©c), `success` (thÃ nh cÃ´ng hay khÃ´ng), `txHash` (náº¿u cÃ³), vÃ  `message` (thÃ´ng Ä‘iá»‡p) Ä‘á»ƒ frontend cÃ³ thá»ƒ hiá»‡n thÃ´ng bÃ¡o rÃµ rÃ ng.

VÃ­ dá»¥ giÃ¡ trá»‹ tráº£ vá»:

1) HoÃ n tiá»n crypto thÃ nh cÃ´ng

```json
{
  "attempted": true,
  "method": "CRYPTO",
  "success": true,
  "txHash": "0xabc123...",
  "message": "ÄÃ£ hoÃ n tiá»n tá»›i 0xCustomer..."
}
```

2) KhÃ´ng thá»±c hiá»‡n hoÃ n tiá»n (khÃ´ng pháº£i crypto hoáº·c tráº¡ng thÃ¡i khÃ´ng phÃ¹ há»£p)

```json
{
  "attempted": false,
  "method": null,
  "success": false,
  "txHash": null,
  "message": "KhÃ´ng thá»±c hiá»‡n hoÃ n tiá»n: paymentMethod != CRYPTO hoáº·c paymentStatus khÃ´ng pháº£i PAID"
}
```

TÃ³m táº¯t cÃ¡ch hoáº¡t Ä‘á»™ng:

- Náº¿u cÃ³ thá»ƒ hoÃ n tiá»n báº±ng crypto thÃ¬ dá»‹ch vá»¥ sáº½:
  - TÃ¬m `CryptoTransaction` gá»‘c liÃªn quan Ä‘áº¿n Ä‘Æ¡n (náº¿u cÃ³).
  - TÃ¬m vÃ­ admin Ä‘ang active (hoáº·c fallback vá» `ADMIN_WALLET_ADDRESS`).
  - KÃ½ vÃ  gá»­i giao dá»‹ch hoÃ n tiá»n báº±ng private key admin (qua Web3).
  - ÄÃ¡nh dáº¥u tráº¡ng thÃ¡i cá»§a giao dá»‹ch gá»‘c lÃ  `REFUNDED` vÃ  chÃ¨n má»™t báº£n ghi `CryptoTransaction` má»›i cho giao dá»‹ch hoÃ n tiá»n (tráº¡ng thÃ¡i `SUCCESS` khi thÃ nh cÃ´ng).
  - Cáº­p nháº­t `Order` thÃ nh `statusOrder = 'CANCELLED'` vÃ  `paymentStatus = 'REFUNDED'` khi hoÃ n tiá»n hoÃ n táº¥t.

- Khi xáº£y ra lá»—i, dá»‹ch vá»¥ tráº£ vá» `success: false` kÃ¨m `message` giáº£i thÃ­ch vÃ  cá»‘ gáº¯ng khÃ´ng Ä‘á»ƒ há»‡ thá»‘ng rÆ¡i vÃ o tráº¡ng thÃ¡i khÃ´ng nháº¥t quÃ¡n.

Ghi chÃº cho developer: lÆ°u private key á»Ÿ dáº¡ng plaintext lÃ  khÃ´ng an toÃ n. NÃªn dÃ¹ng kho quáº£n lÃ½ khÃ³a (KMS) hoáº·c pháº§n cá»©ng kÃ½ (hardware wallet).

### **TrÃ¬nh tá»± hoÃ n tiá»n (chi tiáº¿t):**

```
1. KhÃ¡ch hÃ ng yÃªu cáº§u há»§y order
                â†“
2. Backend tÃ¬m CryptoTransaction gá»‘c
                â†“
3. Kiá»ƒm tra cÃ³ private key admin khÃ´ng
                â†“
4. KÃ½ transaction hoÃ n tiá»n báº±ng private key
                â†“
5. Gá»­i transaction hoÃ n tiá»n lÃªn blockchain
                â†“
6. Blockchain xÃ¡c nháº­n (transaction success)
                â†“
7. Cáº­p nháº­t CryptoTransaction gá»‘c: status = 'REFUNDED'
                â†“
8. Táº¡o CryptoTransaction record má»›i cho hoÃ n tiá»n
                â†“
9. Update Order: statusOrder = 'CANCELLED', paymentStatus = 'REFUNDED'
                â†“
10. Admin Dashboard hiá»ƒn thá»‹ "ÄÃ£ hoÃ n tiá»n"
```

### **Database after refund (example):**

```
CryptoTransaction gá»‘c (Thanh toÃ¡n):
  transactionHash: 0x123...
  fromAddress: 0xCustomer...
  toAddress: 0xAdmin...
  amount: 1 ETH
  status: REFUNDED                    â† ÄÃ¡nh dáº¥u Ä‘Ã£ hoÃ n

CryptoTransaction má»›i (HoÃ n láº¡i):
  transactionHash: 0x456...
  fromAddress: 0xAdmin...
  toAddress: 0xCustomer...
  amount: 1 ETH
  status: SUCCESS
  description: "Refund for cancelled order 123"
```

---

## ğŸ” Báº£o máº­t

### **âš ï¸ Cáº£nh bÃ¡o**

1. **Private Key**: Hiá»‡n táº¡i lÆ°u plaintext trong DB - **NGUY HIá»‚M!**
   - âœ… NÃªn: MÃ£ hÃ³a báº±ng AES-256
   - âœ… NÃªn: Sá»­ dá»¥ng AWS KMS / Azure Key Vault
   - âœ… NÃªn: DÃ¹ng hardware wallet (Ledger, Trezor)

2. **Transaction Verification**: Cáº§n xÃ¡c minh trÃªn blockchain
   - âœ… Check `transaction.to === adminWallet`
   - âœ… Check `transaction.value >= expectedAmount`
   - âœ… Check transaction status = `success`

3. **Gas Price**: Web3 tá»± Ä‘á»™ng estimate, nhÆ°ng nÃªn set max
   - âœ… Äáº·t `maxGasPrice` Ä‘á»ƒ trÃ¡nh overpay

4. **Rate Limiting**: NÃªn rate limit API endpoint
   - âœ… Max 5 payment requests/minute per user

---

## ğŸ§ª Testing

### **Test Refund Flow:**
```bash
# 1. Create test order with crypto payment
POST /api/confirm-crypto-payment
Body: {
  "cartItems": [...],
  "transactionHash": "0x...",
  "fromAddress": "0xCustomerWallet",
  "amount": "1",
  "vndAmount": 50000000
}

# 2. Cancel order
POST /api/cancel-order/123

# 3. Check database
SELECT * FROM `crypto_transactions` WHERE orderId = 123;
```

**Expected result:**
- Original transaction: status = 'REFUNDED'
- New refund transaction: status = 'SUCCESS'
- Order: statusOrder = 'CANCELLED', paymentStatus = 'REFUNDED'

---

## ğŸ“ Troubleshooting

| Lá»—i | NguyÃªn nhÃ¢n | Giáº£i phÃ¡p |
|-----|-----------|---------|
| Transaction not found | Hash sai hoáº·c chÆ°a mine | Kiá»ƒm tra blockchain.com |
| Cannot refund | KhÃ´ng cÃ³ private key | ThÃªm wallet active |
| Wallet mismatch | Admin wallet sai | Update ADMIN_WALLET_ADDRESS |
| Gas estimation failed | Network quÃ¡ táº£i | Thá»­ láº¡i sau |
| Amount precision lost | Float arithmetic | DÃ¹ng String cho amount |

---

## ğŸ“ Tham kháº£o

- **Web3.js**: https://web3js.readthedocs.io/
- **Ethereum JSON-RPC**: https://eth.wiki/json-rpc/API
- **Prisma**: https://www.prisma.io/docs/
- **MetaMask**: https://docs.metamask.io/

---

**Cáº­p nháº­t láº§n cuá»‘i:** November 9, 2025
**PhiÃªn báº£n:** 1.0

---
---
---
---
---
# ğŸ“„ Copyright

All content in the LianHarman repository is copyrighted by the author.  

Â© 2025 [...] â€” All rights reserved.
- You are allowed to use this source code for personal or educational purposes.
- Commercial use or redistribution is not allowed without explicit written permission from the author.




## ğŸ”— Links contact me

[![Facebook](https://img.shields.io/badge/Facebook-1877F2?style=for-the-badge&logo=facebook&logoColor=white)](https://www.facebook.com/thuan.lien.79/)
[![GitHub](https://img.shields.io/badge/GitHub-181717?style=for-the-badge&logo=github&logoColor=white)](https://github.com/LienThuan9697)
[![Email](https://img.shields.io/badge/Gmail-D14836?style=for-the-badge&logo=gmail&logoColor=white)](mailto:lienthuan2004@gmail.com)
[![X (Twitter)](https://img.shields.io/badge/X-000000?style=for-the-badge&logo=twitter&logoColor=white)](https://x.com/harmanlian?s=21)


## Deployment

To project setup

```bash
  npm install
```

To deploy this project run

```bash
  npm start
```


## ğŸ“ŒGit code documentation i have with Vietnamese language
`lÆ°u Ã½: -m kiá»ƒm tra trÆ°á»›c má»›i thá»±c hiá»‡n trong khi -M thá»±c hiá»‡n mÃ  khÃ´ng cáº§n kiá»ƒm tra báº±ng cÃ¡ch ghi Ä‘Ã¨ trá»±c tiáº¿p !!!`

    -m  # DÃ¹ng Ä‘á»ƒ thÃªm thÃ´ng Ä‘iá»‡p commit
    -M  # Ghi Ä‘Ã¨ nhÃ¡nh cÅ©, sá»­ dá»¥ng cáº©n tháº­n!
    -u  # Thiáº¿t láº­p upstream khi push/pull
    -v  # Hiá»‡n chi tiáº¿t quÃ¡ trÃ¬nh thá»±c hiá»‡n
    -b  # Táº¡o nhÃ¡nh má»›i vÃ  chuyá»ƒn ngay sang nhÃ¡nh Ä‘Ã³

___

**`# clone dá»± Ã¡n vá» tá»« github cÃ³ sáº³n:`**
```bash
    git clone https://github.com/username/repository.git
```
___

**`# Äiá»u hÆ°á»›ng Ä‘áº¿n thÆ° má»¥c dá»± Ã¡n`**
```bash
    cd path/to/your/project
```
___

**`# Khá»Ÿi táº¡o kho lÆ°u trá»¯ Git `**
```bash
    git add .
```
___

**`# Cam káº¿t cÃ¡c thay Ä‘á»•i`**
```bash
    git commit -m "Initial commit"
```
___

**`# ThÃªm kho lÆ°u trá»¯ GitHub lÃ m remote repository(káº¿t ná»‘i vá»›i dá»± Ã¡n cÃ³ trÃªn git)`**
```bash
    git remote add origin â€https://github.com/username/repository.gitâ€
```
___

**`# kiá»ƒm tra nhÃ¡nh hiá»‡n táº¡i`**
```bash
    git branch
```
___

**`# náº¿u tÃªn nhÃ¡nh cá»§a báº¡n lÃ  master thay vÃ¬ main, báº¡n cáº§n Ä‘á»•i tÃªn nhÃ¡nh thÃ nh main`**
```bash
    git branch -M main
```
___


**`# XÃ³a NhÃ¡nh `**  
**`VÃ­ dá»¥: xÃ³a nhÃ¡nh master`**
```bash
    git push origin --delete master
```
___

**`# Äáº©y mÃ£ lÃªn GitHub`**
```bash
    'git push -u origin main' hoáº·c 'git push origin main' náº¿u muá»‘n ghi Ä‘Ã¨ hoáº·c thay tháº¿ táº¥t cáº£ thÃªm '--force' vÃ o sau chá»¯ 'main'
```
___

**`# Äá»•i tÃªn nhÃ¡nh tá»« master sang main`**
```bash
    git branch -M <tÃªn_cÅ©> <tÃªn_má»›i>  -> "vÃ­ dá»¥: git branch -M master main"
```
___

**`# Táº¡o nhÃ¡nh má»›i nhanh vÃ  chuyá»ƒn sang nhÃ¡nh Ä‘Ã³ luÃ´n`**
```bash
    git checkout -b â€˜tÃªn nhÃ¡nh má»›iâ€™  ==> `-b lÃ  branch tá»©c lÃ  táº¡o nhÃ¡nh má»›i`
```
___

**`# Check code táº¡i qua tÃªn nhÃ¡nh Ä‘Ã³`**
```bash
    git checkout  â€˜tÃªn nhÃ¡nh checkâ€™
```
___

**`# quay láº¡i code cÅ© vá»›i má»™t commit báº±ng mÃ£ commit hash-ID`**
```bash
    git checkout â€˜HashIDâ€˜
```
___

**`# Äá»ƒ quay láº¡i commit cÅ© ta cÃ³`**  
1 xem lá»‹ch sá»­ commit: 
```bash
    git log
```
2 Chá»n commit muá»‘n quay láº¡i mÃ  khÃ´ng xÃ³a cÃ¡c commit khÃ¡c:
```bash
    git revert [id-commit]
```
`Hoáº·c` quay láº¡i vÃ  xÃ³a commit khÃ¡c:
```bash
    git revert --hard [id-commit]
```
**`- lÆ°u Ã½: quay láº¡i commit khÃ´ng Ä‘á»“ng nghÄ©a remote trÃªn git cÅ©ng quay láº¡i theo, nÃ³ váº«n náº±m á»Ÿ Ä‘Ã³ báº¡n chá»‰ cÃ³ thá»ƒ thá»±c hiá»‡n thá»§ cÃ´ng !!`**

___

**`# Coming soon ğŸ§ `**
```bash
    let's wait ğŸš€
```
___

## Táº¡o BackEnd cÆ¡ báº£n:
**`táº¡o package quáº£n lÃ½ npm`**
```bash
    npm init
```
___

## Táº£i thÆ° viá»‡n:
**`Táº£i thÆ° viá»‡n Express cho Backend`**
```bash
    npm i --save-exact express
```

- Ä‘á»ƒ cháº¡y dá»± Ã¡n nÃ y dÃ¹ng cÃ¢u lá»‡nh: `node app.js`
___

## Setup TypeScript cho dá»± Ã¡n Node.js:
**`Báº£n cháº¥t cá»§a viá»‡c setup TypeScript`**  
1. Báº¡n coding báº±ng cÃº phÃ¡p cá»§a TypeScript: má»¥c Ä‘Ã­ch lÃ  code Ä‘Æ°á»£c gá»£i Ã½, vÃ  code Ã­t lá»—i hÆ¡n  
2. Báº¡n cáº§n sá»­ dá»¥ng thÆ° viá»‡n Ä‘á»ƒ dá»‹ch code tá»« typescript sang javascript  
3. Node.js sáº½ thá»±c thi code Ä‘Ã£ dá»‹ch (javascript)  

`BÆ°á»›c 1: CÃ i Ä‘áº·t thÆ° viá»‡n:`
```bash
    npm i --save-exact --save-dev typescript @types/express @types/node
```
ThÆ° viá»‡n typescript, giÃºp dá»‹ch code typescript, sang code javascript  
ThÆ° viá»‡n @types/express, giÃºp báº¡n coding Express Ä‘Æ°á»£c gá»£i Ã½ code  
ThÆ° viá»‡n @types/node giÃºp báº¡n coding nodejs Ä‘Æ°á»£c gá»£i Ã½ code  

vÃ  Ä‘á»•i Ä‘uÃ´i file app.js thÃ nh .ts

`BÆ°á»›c 2: Cáº¥u hÃ¬nh typescript:`
```bash
    npx tsc --init
```
táº¡o file: `tsconfig.json` táº¡i root
```bash
    {
        "compilerOptions": {
            "module": "commonjs",
            "esModuleInterop": true,
            "target": "es6",
            "sourceMap": true,
            "skipLibCheck": true,
            "outDir": "dist"
        }
    }
```

//giáº£i thÃ­ch Ã½ nghÄ©a
ğŸ”— [Chi tiáº¿t, tham kháº£o](https://www.typescriptlang.org/docs/handbook/tsconfig-json.html)

`BÆ°á»›c 3: Dá»‹ch code TypeScript sang JavaScript`
```bash
    npx tsc
```

`BÆ°á»›c 4: Cháº¡y dá»± Ã¡n`
```bash
    node dist/app.js
```
___


## Setup Typescript
**`setup thÃªm cho dá»± Ã¡n`**

Update `tsconfig.json`
```bash
    "rootDir": "src",
```

update `package.json`
```bash
    "scripts": {
        "test": "echo \"Error: no test specified\" && exit 1",
        "start": "tsc && node dist/app.js",
        "dev": "tsc && node dist/app.js"
    }
```

Cháº¡y dá»± Ã¡n vá»›i cÃ¢u lá»‡nh:
```bash
    npm run dev
```
hoáº·c 
```bash 
    npm start
```
___


## Setup DevTool:
**`Má»¥c tiÃªu: cháº¡y project táº¡i cháº¿ Ä‘á»™ â€˜watchâ€™. Má»—i láº§n cÃ³ file thay Ä‘á»•i, project sáº½ tá»± Ä‘á»™ng cháº¡y láº¡i`**
//TÃ i liá»‡u:  
ğŸ”— [tham kháº£o 1](https://www.npmjs.com/package/nodemon)  

CÃ i Ä‘áº·t thÆ° viá»‡n
```bash
    npm i --save-exact --save-dev nodemon ts-node dotenv
    npm i --save-exact dotenv
```

thÃªm cáº¥u hÃ¬nh nÃ y sao khi cÃ i thÆ° viá»‡n cho Backend vÃ o file `package.json`:
```bash
    "nodemonConfig": {
        "watch": ["src"],
        "ext": "ts",
        "exec": "ts-node ./src/app.ts",
        "ignore": ["dist", "node_modules"]
    },
```
vÃ  Ä‘á»•i scripts trong file `package.json` thÃ nh nhÆ° sau:
```bash 
    "scripts": {
        "test": "echo \"Error: no test specified\" && exit 1",
        "start": "nodemon",
        "dev": "nodemon"
    },
```

táº¡o file `.env` vÃ  cáº¥u hÃ¬nh trong file app.ts thÃªm thÆ° viá»‡n nÃ y vÃ´ 
___

## Cáº¥u hÃ¬nh EJS cho project (tá»©c giao diá»‡n cho backend Ä‘á»ƒ cháº¡y mÃ´ hÃ¬nh SSR)
**`Template: tá»©c lÃ  bá»™ khung Ä‘á»‹nh hÃ¬nh sáºµn vÃ­ dá»¥ template wedding cháº³ng háº¡n, ngÆ°á»i bÃ¡n hÃ ng Ä‘Æ°a sáºµn template, báº¡n chá»‰ cáº§n chá»n vÃ  fill tÃªn vÃ o thÃ´i.`**

ğŸ”— [tham kháº£o](https://expressjs.com/en/guide/using-template-engines.html)  

cÃ i Ä‘áº·t EJS cho backend:
```bash
    npm i --save-exact ejs
    npm i --save-exact --save-dev @types/ejs

```
táº¡o thÃªm folder cho views vÃ  file vá»›i tÃªn mong muá»‘n:
Ä‘á»ƒ hiá»ƒn thá»‹ ná»™i dung file Ä‘Ã³ lÃªn giao diá»‡n web cáº§n khai bÃ¡o tÃªn file vÃ  nguá»“n cá»§a file!
nÃ³ sáº½ Ä‘Æ°á»£c hiá»ƒn báº±ng phÆ°Æ¡ng thá»©c get cá»§a express qua res:
```bash 
    app.set('view engine', 'ejs');
    app.set('views', __dirname + '/views');

    app.get('/', (req,res) => {
        res.render('home.ejs');
    });
```
___

# MÃ´ hÃ¬nh MVC vÃ  File static
**`MVC lÃ  viáº¿t táº¯t cá»§a Model - View - Controlle`**
giÃºp viáº¿t code theo tá»• chá»©c, dá»… dÃ ng báº£o trÃ¬ (maintain) vÃ  má»Ÿ rá»™ng (scale) á»©ng dá»¥ng.  

- Tá»• chá»©c thÆ° má»¥c cho dá»± Ã¡n  
`Táº¡o controllers`  
`Táº¡o models`  
`Táº¡o services`  
`Táº¡o routes`  

(táº¡o route)[https://expressjs.com/en/guide/routing.html]  

Táº¡o thÃªm cÃ¡c thÆ° má»¥c nhÆ° models, routes, controllers vÃ  services Ä‘á»ƒ cáº¥u hÃ¬nh dá»± Ã¡n theo MVC.  
Trong folder routes táº¡o 1 file `web.ts` cho dá»± Ã¡n vá»›i cÃ¡c url cá»§a trang web.
```bash
    import express, {Express} from 'express';

    const router = express.Router();

    const webroutes = (app: Express) => {

        router.get('/', (req, res) => {
            res.render('home.ejs');
        });

        router.get('/about', (req, res) => {
            res.send('About page this BackEnd !');
        });

        app.use('/' , router);
    }
    export default webroutes;

```
thay vÃ¬ pháº£i rander trá»±c tiáº¿p trong file `app.ts` ta chá»‰ cáº§n rander cÃ¡c url cá»§a nÃ³ trong file nÃ y giÃºp ta dá»… dÃ ng quáº£n lÃ­ hÆ¡n !

1. Sá»­a láº¡i ná»™i dung trong file `app.ts`:  
`thay ná»™i dung dÆ°á»›i nÃ y`
```bash 
    router.get('/', (req, res) => {
        res.render('home.ejs');
    });
```
2. thÃ nh nhÆ° nÃ y
```bash
    webroutes(app);
```
3. vÃ  import file `web.ts` vÃ o trong `app.ts`:
```bash
    import webroutes from './routes/web';
```
Sau cÃ¡c bÆ°á»›c trÃªn ta táº¡o thÃªm thÆ° má»¥c `public` Ä‘á»ƒ lÃ m nÆ¡i lÆ°u static File.  
bÃªn trong code `app.ts` cáº§n thÃªm dÃ²ng code bÃªn dÆ°á»›i Ä‘á»ƒ nÃ³ cÃ³ thá»ƒ Ä‘á»c Ä‘Æ°á»£c cÃ¡c file cá»§a thÆ° má»¥c `public`:  
```bash 
    app.use(express.static('public'));
```
___

## Táº£i thÆ° viÃªn Tsconfig_paths
**`dÃ¹ng thÆ° viá»‡n nÃ y Ä‘á»ƒ thay Ä‘á»•i Ä‘Æ°á»ng link absolute paths thÃ nh Relative Path `**

táº£i thÆ° viá»‡n báº±ng code bÃªn dÆ°á»›i:
```bash
    npm i --save-dev --save-exact tsconfig-paths
```
bá»• sung thÃªm cÃ¡c dÃ²ng lá»‡nh bÃªn dÆ°á»›i Ä‘á»ƒ cÃ³ thá»ƒ láº¥y Ä‘Æ°á»£c cÃ³ file theo Ä‘Æ°á»ng dáº«n khi khai bÃ¡o cho cÃ¡c file.

```bash 
    "baseUrl": ".", 
    "paths": {
      "config/*":["./src/config/*"],
      "controllers/*" : ["./src/controllers/*"],
      "models/*" : ["./src/models/*"],
      "routes/*" : ["./src/routes/*"], 
      "services/*" : ["./src/services/*"],
      "views/*" : ["./src/views/*"],    
    },
```

vÃ  bá»• sung thÃªm code cho file `package.jon`:
```bash 
    "exec": "ts-node -r tsconfig-paths/register ./src/app.ts",
```


___

## ThÃªm thÆ° viá»‡n SQL2
**`thao tÃ¡c vá»›i database mysql`**

cÃ i thÆ° viá»‡n sql2:
```bash 
    npm i --save-exact mysql2
```
táº¡o thÃªm thÆ° má»¥c `config` vÃ  file `db.ts` Ä‘á»ƒ káº¿t ná»‘i vá»›i database   
trong file `db.ts` cÃ³ cÃ¡c thÃ´ng tin sau Ä‘á»ƒ káº¿t ná»‘i vá»›i database:
```bash
    import mysql from 'mysql2/promise'

    const GetConnection = async () =>{
        const connection = await mysql.createConnection({
            port: 3306,
            host: 'your host ',
            user: ' name user ',
            password: ' your password',
            database:' your database',
        });
        // A simple SELECT query
        try {
            const [results, fields] = await connection.query(
                'SELECT * FROM `User`'
            );

            console.log(results); // results contains rows returned by server
            console.log(fields); // fields contains extra meta data about results, if available
        } catch (err) {
            console.log(err);
        };
        return connection;
    };

    export default GetConnection;
```

### CÃ i ORM Prisma cho mÃ´i trÆ°á»ng.

- 1 cÃ i thÆ° viá»‡n prima cho dá»± Ã¡n:
```bash
    npm i --save-dev --save-exact prisma
```
- 2 cÃ i luÃ´n extention prisma cho IDE visual code Ä‘á»ƒ Ä‘Æ°á»£c gá»£i Ã½ code trong quÃ¡ trÃ¬nh coding

- 3 sau cÃ¡c bÆ°á»›c trÃªn ta tiáº¿n hÃ nh setup prisma cho dá»± Ã¡n cÃ¡ nhÃ¢n:
Ä‘á»ƒ xem táº¥t cáº£ cÃ¡c cÃ¢u lá»‡nh mÃ  prisma há»— trá»£:
    ```bash 
        npx prisma
    ```
    Ä‘á»ƒ prisma táº¡o 1 file lÆ°u code database Ä‘á»ƒ quáº£n lÃ½ database, dÃ¹ng cá»©u phÃ¡p sau:
    ```bash
        npx prisma init
    ```
    nÃ³ sáº½ táº¡o ra 1 folder prisma cÃ³ file schema vÃ  1 file .env Ä‘á»ƒ lÆ°u Ä‘Æ°á»ng dáº«n Ä‘áº¿n database káº¿t ná»‘i.
    trong file schema láº¥y tÃªn database theo cá»©u phÃ¡p prisma Ä‘Æ°a "[prisma](https://www.prisma.io/docs/getting-started/setup-prisma/add-to-existing-project/relational-databases/connect-your-database-typescript-mysql)"

    ```bash
        // This is your Prisma schema file,
        // learn more about it in the docs: https://pris.ly/d/prisma-schema

        // Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
        // Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

        generator client {
        provider = "prisma-client-js"
        }

        datasource db {
        provider = "mysql"
        url      = env("DATABASE_URL")
        }
    ```
    vÃ  file .env setup nhÆ° tÃ i liá»‡u cá»§a "[prisma](https://www.prisma.io/docs/getting-started/setup-prisma/add-to-existing-project/relational-databases/connect-your-database-typescript-mysql)"

    ```bash
        NODE_ENV=development
        PORT = 8080
        # This was inserted by `prisma init`:
        # Environment variables declared in this file are automatically made available to Prisma.
        # See the documentation for more detail: https://pris.ly/d/prisma-schema#accessing-environment-variables-from-the-schema

        # Prisma supports the native connection string format for PostgreSQL, MySQL, SQLite, SQL Server, MongoDB and CockroachDB.
        # See the documentation for all the connection string options: https://pris.ly/d/connection-strings

        DATABASE_URL="mysql://USER:PASSWORD@HOST:PORT/DATABASE"
    ```

- 4 sau khi setup táº¥t cáº£ cÃ¡c bÆ°á»›c trÃªn thÃ¬ cáº§n cÃ¡i prisma client Ä‘á»ƒ nÃ³ thao tÃ¡c vá»›i database:
    ```bash
        npm i @prisma/client
    ```
# cÃ¡c má»‘i quan há»‡ trong "[Prisma](https://www.prisma.io/docs/orm/prisma-schema/data-model/relations/one-to-one-relations)"
  

# Cáº­p nháº­t code cho typescript cá»§a prisma:
- 1 Ä‘á»ƒ Ä‘Æ°á»£c gá»£i Ã½ code khi cáº­p nháº­t láº¡i database cÃ³ cÃ¢u lá»‡nh sao:
    ```bash
        npx prisma generate
    ```
- 2 Ä‘á»ƒ Ä‘Æ°a code trong file `schema.prisma` Ä‘á»ƒ táº¡o báº£ng vÃ o database:
    ```bash
        npx prisma db push
    ```
- 3 kÃ©o cÃ¡c báº£ng( hoáº·c láº¥y cáº¥u trÃºc báº£ng Ä‘ang cÃ³ trong database Ä‘á»ƒ ghi vÃ o file `schema.prisma` Ä‘á»ƒ táº¡o thÃ nh code khung. ) vá» file `schema.prisma`
    ```bash
        npx prisma db pull
    ```

- 4 Ä‘Æ°a code Ä‘Ã³ vÃ o database Ä‘á»“ng thá»i táº¡o migrate cho prisma Ä‘á»ƒ lÆ°u láº¡i lá»‹ch sá»­ cáº­p nháº­t code cá»§a database ( lÆ°u Ã½: code khung sá»‘ 2 pháº£i cÃ³ trÆ°á»›c má»›i cháº¡y Ä‘Æ°á»£c lá»‡nh nÃ y ).
    ```bash
        npx prisma migrate dev --name "tÃªn pháº§n cáº­p nháº­t Ä‘Ã³"
    ```

# Pagination with "[Prisma](https://www.prisma.io/docs/orm/prisma-client/queries/pagination)":
  

- prisma it take keyword 'limit' and 'offset' replace with limit->take, offset->skip
- recipe take number skip: " Page * PageSize "
- With take you pass in as much as you want.


### Middleware cá»§a multer.ts
```bash
    import multer from 'multer'
    import path from 'path'
    import { v4 } from 'uuid';


    const fileUploadMiddleware = (fieldName: string /* tÃªn trÆ°á»ng file */, dir: string = 'images' /* thÆ° má»¥c lÆ°u trá»¯ */) => {
        return multer({
            storage: multer.diskStorage({
                destination: 'public/' + dir,// cáº¥u hÃ¬nh ná»›i lÆ°u trá»¯ file vá»›i thÆ° má»¥c public vÃ  dir lÃ  thÆ° má»¥c con
                filename: (req, file, cb) => {
                    const extension = path.extname(file.originalname); // láº¥y pháº§n má»Ÿ rá»™ng cá»§a file
                    cb(null, v4() + extension); // táº¡o tÃªn file duy nháº¥t báº±ng cÃ¡ch sá»­ dá»¥ng uuid
                }
            }),
            limits: {
                fileSize: 1024 * 1024 * 3 //3MB - giá»›i háº¡n kÃ­ch thÆ°á»›c file
            },
            fileFilter: (req: Express.Request, file: Express.Multer.File, cb: Function) => {
                if (
                    file.mimetype === 'image/png' ||
                    file.mimetype === 'image/jpg' ||
                    file.mimetype === 'image/jpeg' // kiá»ƒm tra loáº¡i file
                ) {
                    cb(null, true); // cho phÃ©p file náº¿u loáº¡i há»£p lá»‡
                } else {
                    cb(new Error('Only JPEG and PNG images are allowed.'), false);
                }
            }
        }).single(fieldName); // sá»­ dá»¥ng single Ä‘á»ƒ upload má»™t file duy nháº¥t


    }
    export default fileUploadMiddleware;
```

# CÃ i thÆ° viá»‡n Json Web Token cho sever há»— trá»£ xÃ¡c thá»±c ngÆ°á»i dÃ¹ng.
```bash
    npm i --save-exact jsonwebtoken @types/jsonwebtoken
```
and
```bash
    npm i --save-exact --save-dev @types/jsonwebtoken
```
tÃ i liá»‡u tham kháº£o [JsonWebToken](https://www.npmjs.com/package/jsonwebtoken)
- jwt.sign(payload, secretOrPrivateKey, [options, callback])
  - payload: lÃ  dá»¯ liá»‡u gá»­i lÃªn kÃ¨m request.
  - secretOrPrivateKey: lÃ  chá»¯ kÃ½ mÃ  sever kÃ½ Ä‘á»ƒ chá»‰ sever Ä‘Ã³ giáº£i mÃ£ Ä‘Æ°á»£c token nÃ y
  - [options, callback]: á»Ÿ Ä‘Ã¢y cÃ³ thá»ƒ chuyá»n vÃ o thá»i gian háº¿t háº¡n cá»§a key token Ä‘Ã³ { expiresIn: "1d" } 1d á»Ÿ Ä‘Ã¢y Ä‘Æ°á»£c ghi theo cÃº phÃ¡p cá»§a thÆ° viá»‡n vercel Ä‘Æ°á»£c ghi rÃµ trong tÃ i liá»‡u trÃªn.

# Táº¡o 1 middleware Ä‘á»ƒ xÃ¡c thá»±c thÃ´ng tin ngÆ°á»i dÃ¹ng vá»›i token gá»­i lÃªn header cá»§a req
- file middleware cÃ³ tÃªn **[jwt.middleware.ts](https://gitlab.com/LienThuan9697/nodejs_express/-/blob/master/src/middleware/jwt.middleware.ts?ref_type=heads)** cÃ³ ná»™i dung nhÆ° sau:
    ```bash
        import { Request, Response, NextFunction } from "express";
        import jwt from 'jsonwebtoken';
        import "dotenv/config"; // Load environment variables from .env file

        const checkValidJWT = (req: Request, res: Response, next: NextFunction) => {
            const path = req.path; // Láº¥y Ä‘Æ°á»ng dáº«n cá»§a request hiá»‡n táº¡i
            const whitelistPaths = [ // ThÃªm cÃ¡c endpoint cÃ´ng khai khÃ¡c Ä‘á»ƒ khÃ´ng cáº§n check JWT vÃ o Ä‘Ã¢y náº¿u cáº§n
                '/add-product-to-cart',
                '/login',
            ];
            const isWhitelisted = whitelistPaths.includes(path);
            console.log(`Request path: ${path}, isWhitelisted: ${isWhitelisted}`);
            if (isWhitelisted === true) {
                next(); // Náº¿u Ä‘Æ°á»ng dáº«n náº±m trong whitelist, bá» qua kiá»ƒm tra JWT
                return;
            };

            const token = req.headers.authorization; // Láº¥y token tá»« header Authorization cá»§a request
            if (!token || !token.startsWith('Bearer ')) { // Kiá»ƒm tra token cÃ³ tá»“n táº¡i vÃ  Ä‘Ãºng Ä‘á»‹nh dáº¡ng Bearer khÃ´ng
                res.status(401).json({ message: 'Unauthorized: No token provided' });
                return;
            } else {
                try {
                    const jwtToken = token.split(' ')[1]; // Láº¥y pháº§n token sau "Bearer "
                    const dataDecoded: any = jwt.verify(jwtToken, process.env.JWT_SECRET_KEY as string); // Giáº£i mÃ£ token sá»­ dá»¥ng secret key tá»« biáº¿n mÃ´i trÆ°á»ng .env
                    console.log("Decoded JWT data:", dataDecoded);
                    req.UserJWT = { //UserJWT nÃ y Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a trong src/types/index.dt.ts 
                        id: dataDecoded.id ?? dataDecoded.userId ?? 0,
                        fullName: dataDecoded.fullName ?? '',
                        email: dataDecoded.email ?? '',
                        avatar: dataDecoded.avatar ?? '',
                        roleId: dataDecoded.roleId ?? 0,
                        roleName: dataDecoded.roleName ?? '',
                        accountType: dataDecoded.accountType ?? '',
                    };
                    next(); // Tiáº¿p tá»¥c xá»­ lÃ½ request 
                } catch (error) {
                    console.error("JWT verification error:", error instanceof Error ? error.message : ''); // Ghi log lá»—i xÃ¡c thá»±c JWT cá»¥ thá»ƒ
                    res.status(401).json({ message: 'Unauthorized: Invalid token', error: error instanceof Error ? error.message : '', data: null }); // Pháº£n há»“i lá»—i xÃ¡c thá»±c JWT
                };
            };
        };

        export { checkValidJWT };
    ```
tÃ i liá»‡u tham kháº£o [JsonWebToken](https://www.npmjs.com/package/jsonwebtoken)
- jwt.verify(token, secretOrPublicKey, [options, callback])
  - token lÃ  key lÃºc Ä‘áº§u mÃ£ hÃ³a dá»¯ liá»‡u.
  - secretOrPrivateKey lÃ  chá»¯ kÃ½ mÃ  sever kÃ½ Ä‘á»ƒ chá»‰ sever Ä‘Ã³ giáº£i mÃ£ Ä‘Æ°á»£c token nÃ y

- Äá»ƒ Ä‘á»‹nh nghÄ©a Ä‘Æ°á»£c biáº¿n UserJWT nhÆ° trÃªn ta cÃ³ code tham kháº£o sau:
Táº¡o kiá»ƒu dá»¯ liá»‡u má»›i vÃ  Ä‘á»‹nh nghÄ©a nÃ³ Ä‘á»ƒ dÃ¹ng Ä‘Æ°á»£c trong pháº§n req cá»§a express
    ```bash
        type UserJWT = { // Äá»‹nh nghÄ©a kiá»ƒu cho dá»¯ liá»‡u UserJWT
            id: number;
            fullName: string;
            email: string;
            avatar: string;
            roleId: number;
            accountType: string;
        };
        export type { UserJWT }; // Xuáº¥t kiá»ƒu UserRole vÃ  UserJWT
        declare global {
        namespace Express {
                interface Request { // Má»Ÿ rá»™ng Request Ä‘á»ƒ bao gá»“m UserJWT
                    UserJWT: UserJWT; // UserJWT nÃ y Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a á»Ÿ trÃªn
                }
            }
        };
    ```
    Chi tiáº¿t cÃ³ thá»ƒ tham kháº£o file á»Ÿ **[src/types/index.dt.ts](https://gitlab.com/LienThuan9697/nodejs_express/-/blob/master/src/types/index.dt.ts?ref_type=heads)**

# Build docker compose vá»›i mysql:
- viáº¿t file docker-compose.yaml Ä‘á»ƒ build database báº±ng docker nhÆ° sau:
```bash
version: '3.8' # phiÃªn báº£n docker-compose
services: # Ä‘á»‹nh nghÄ©a cÃ¡c dá»‹ch vá»¥
  db: # tÃªn dá»‹ch vá»¥
    image: mysql:8.0 # sá»­ dá»¥ng image mysql phiÃªn báº£n 8.0
    container_name: DbMysql_LaptopShop_blockchain # tÃªn container
    restart: unless-stopped # tá»± Ä‘á»™ng khá»Ÿi Ä‘á»™ng láº¡i trá»« khi bá»‹ dá»«ng thá»§ cÃ´ng
    environment: # thiáº¿t láº­p biáº¿n mÃ´i trÆ°á»ng
      MYSQL_ROOT_PASSWORD: LianHarman2049 # pass cá»§a user root
      MYSQL_DATABASE: LaptopShopDB # tÃªn database muá»‘n táº¡o
      MYSQL_USER: LianHarman # biáº¿n nÃ y Ä‘áº·t Ä‘á»ƒ táº¡o user má»›i vÃ  cáº¥p quyá»n cho user Ä‘Ã³
      MYSQL_PASSWORD: LianHarman2049 # pass cá»§a user má»›i táº¡o
    ports: # Ã¡nh xáº¡ cá»•ng
      - "3307:3306" # Ã¡nh xáº¡ cá»•ng 3306 trong container ra cá»•ng 3307 trÃªn host
    # volumes: # gáº¯n volume Ä‘á»ƒ lÆ°u trá»¯ dá»¯ liá»‡u
    #   - db_data:/var/lib/mysql # lÆ°u dá»¯ liá»‡u mysql vÃ o volume db_data
    # networks: # Specify the network
    #   - mysql_network
```
- Sau Ä‘Ã³ cháº¡y lá»‡nh sau Ä‘á»ƒ build cÆ¡ sá»Ÿ dá»¯ liá»‡u tá»« file nÃ y(nhá»› má»Ÿ cmd á»Ÿ file nÃ y !):
```bash
docker compose -p ~this_name_container~ up -d
```
docker compose: ÄÃ¢y lÃ  lá»‡nh dÃ¹ng Ä‘á»ƒ cháº¡y docker-compose.yml. NÃ³ sáº½ táº¡o vÃ  quáº£n lÃ½ nhiá»u container cÃ¹ng 1 lÃºc theo cáº¥u hÃ¬nh trong file.

-p: NÃ³ dÃ¹ng Ä‘á»ƒ Ä‘áº·t tÃªn chung cho táº¥t cáº£ nhá»¯ng thá»© mÃ  compose táº¡o ra tá»« TÃªn container,TÃªn network, TÃªn volume (náº¿u cÃ³).

up: Táº¡o container vÃ  cháº¡y chÃºng, Náº¿u container chÆ°a tá»“n táº¡i â†’ Docker sáº½ build vÃ  cháº¡y, Náº¿u container Ä‘Ã£ tá»“n táº¡i â†’ Docker cháº¡y láº¡i.

-d: detached mode (cháº¡y ngáº§m) khÃ´ng chiáº¿m cmd hiá»‡n táº¡i Ä‘ang gÃµ lá»‡nh nÃ y.

 - Sau khi build cÃ³ thá»ƒ kiá»ƒm tra container cÃ³ cháº¡y hay chÆ°a báº±ng lá»‡nh:
 ```bash
 docker ps
```
hoáº·c vÃ o docker Ä‘á»ƒ xem.

- Build Dockerfile cho dá»± Ã¡n nhÆ° tháº¿ nÃ o cÃ³ thá»ƒ xem Docker file cá»§a dá»± Ã¡n nÃ y [Dockerfile](https://github.com/LienThuan04/BlockChain-Dapp/blob/master/Dockerfile).

- cÃ¡ch táº¡o compose dá»± Ã¡n backend nÃ y cÃ¹ng vá»›i database mysql náº±m á»Ÿ Ä‘Ã¢y: [docker-compose.yaml](https://github.com/LienThuan04/BlockChain-Dapp/blob/master/docker/nodejs/docker-compose.yaml).


# CÃ¡ch chuyá»ƒn file `.tar` cho ngÆ°á»i dÃ¹ng docker khÃ¡c cÃ i container:

- BÆ°á»›c 1: commit images Ä‘Ã³ cáº§n lÆ°u share:
```bash
docker commit `id image` `tÃªn má»›i cá»§a image cá»§a comit`:`tag name`
```
- BÆ°á»›c 2: kiá»ƒm tra láº¡i commit má»›i lÆ°u Ä‘Ã³ cÃ³ tá»“n táº¡i hay chÆ°a:
```bash
docker images
```
- BÆ°á»›c 3: save images vÃ o 1 file `.tar` cáº¥u hÃ¬nh Ä‘á»ƒ gá»­i:
```bash
docker save -o `namefile.tar` `id images(cÃ³ thá»ƒ lÆ°u nhiá»u images Ä‘Ã³ thÃ nh 1 file duy nháº¥t báº±ng cÃ¡ch khoáº£ng)`
```
khi chuyá»ƒn file `.tar` cho ngÆ°á»i khÃ¡c khi cháº¡y lá»‡nh `docker load -i (tÃªn file tar Ä‘Ã£ share)` thÃ¬ trong images cá»§a ngÆ°á»i nháº­n khi cháº¡y lá»‡nh nÃ y trong docker láº¡i khÃ´ng cÃ³ tag name nÃªn ta cáº§n Ä‘áº·t láº¡i tÃªn cho nÃ³ hoáº·c dÃ¹ng id khá»i Ä‘áº·t tÃªn cá»§ng Ä‘Æ°á»£c.

```bash
docker tag id_images name_new_for_this_images
```

- Sau cÃ¹ng create docker-compose.yaml vÃ  setting cho nÃ³:
```bash
services:
  db:
    image: 75081c5f7b17  # DÃ™NG TRá»°C TIáº¾P IMAGE ID
    container_name: DbMysql_LaptopShop_blockchain # cÃ³ thá»ƒ thÃªm láº¡i má»¥c nÃ y náº¿u muá»‘n Ä‘áº·t tÃªn cho nÃ³ trong container
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: LianHarman2049
      MYSQL_DATABASE: LaptopShopDB
      MYSQL_USER: LianHarman
      MYSQL_PASSWORD: LianHarman2049
    ports:
      - "3307:3306"

  server:
    image: 80955feea3b8  # DÃ™NG TRá»°C TIáº¾P IMAGE ID
    restart: unless-stopped
    container_name: Nodejs_LaptopShop_blockchain # cÃ³ thá»ƒ thÃªm láº¡i má»¥c nÃ y náº¿u muá»‘n Ä‘áº·t tÃªn cho nÃ³ trong container
    depends_on:
      - db
    environment:
      DATABASE_URL: "mysql://root:LianHarman2049@db:3306/LaptopShopDB"
    ports:
      - "8081:8080"
```

- BÆ°á»›c 4: cháº¡y setup dá»± Ã¡n bÃªn ngÆ°á»i nháº­n:
```bash
docker load -i namefile.tar
docker-compose up -d
```
- táº­n hÆ°á»Ÿng thÃ nh quáº£!



































## <h3 align="left">Languages and Tools:</h3>

<p align="left"> <a href="https://getbootstrap.com" target="_blank" rel="noreferrer"> <img src="https://raw.githubusercontent.com/devicons/devicon/master/icons/bootstrap/bootstrap-plain-wordmark.svg" alt="bootstrap" width="40" height="40"/> </a> <a href="https://www.w3schools.com/css/" target="_blank" rel="noreferrer"> <img src="https://raw.githubusercontent.com/devicons/devicon/master/icons/css3/css3-original-wordmark.svg" alt="css3" width="40" height="40"/> </a> <a href="https://www.docker.com/" target="_blank" rel="noreferrer"> <img src="https://raw.githubusercontent.com/devicons/devicon/master/icons/docker/docker-original-wordmark.svg" alt="docker" width="40" height="40"/> </a> <a href="https://git-scm.com/" target="_blank" rel="noreferrer"> <img src="https://www.vectorlogo.zone/logos/git-scm/git-scm-icon.svg" alt="git" width="40" height="40"/> </a> <a href="https://www.w3.org/html/" target="_blank" rel="noreferrer"> <img src="https://raw.githubusercontent.com/devicons/devicon/master/icons/html5/html5-original-wordmark.svg" alt="html5" width="40" height="40"/> </a> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript" target="_blank" rel="noreferrer"> <img src="https://raw.githubusercontent.com/devicons/devicon/master/icons/javascript/javascript-original.svg" alt="javascript" width="40" height="40"/> </a> <a href="https://www.mysql.com/" target="_blank" rel="noreferrer"> <img src="https://raw.githubusercontent.com/devicons/devicon/master/icons/mysql/mysql-original-wordmark.svg" alt="mysql" width="40" height="40"/> </a> <a href="https://www.postgresql.org" target="_blank" rel="noreferrer"> <img src="https://raw.githubusercontent.com/devicons/devicon/master/icons/postgresql/postgresql-original-wordmark.svg" alt="postgresql" width="40" height="40"/> </a> <a href="https://postman.com" target="_blank" rel="noreferrer"> <img src="https://www.vectorlogo.zone/logos/getpostman/getpostman-icon.svg" alt="postman" width="40" height="40"/> </a> <a href="https://reactjs.org/" target="_blank" rel="noreferrer"> <img src="https://raw.githubusercontent.com/devicons/devicon/master/icons/react/react-original-wordmark.svg" alt="react" width="40" height="40"/> </a> <a href="https://redux.js.org" target="_blank" rel="noreferrer"> <img src="https://raw.githubusercontent.com/devicons/devicon/master/icons/redux/redux-original.svg" alt="redux" width="40" height="40"/> </a> <a href="https://sass-lang.com" target="_blank" rel="noreferrer"> <img src="https://raw.githubusercontent.com/devicons/devicon/master/icons/sass/sass-original.svg" alt="sass" width="40" height="40"/> </a> <a href="https://tailwindcss.com/" target="_blank" rel="noreferrer"> <img src="https://www.vectorlogo.zone/logos/tailwindcss/tailwindcss-icon.svg" alt="tailwind" width="40" height="40"/> </a> </p>