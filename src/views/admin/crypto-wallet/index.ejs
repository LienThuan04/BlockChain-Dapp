<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="Crypto Wallet - Admin" />
    <meta name="author" content="LianHarman" />
    <title>Crypto Wallet - Admin</title>
    <link rel="icon" type="image/svg+xml" href="/im/Logo-Admin.svg">
    <link href="/admin/css/styles.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .detail-row {
            background-color: #f8f9fa;
        }
    </style>
</head>

<body class="sb-nav-fixed">
    <!-- header -->
    <%- include('../layout/header.ejs') -%>

    <!-- main content -->
    <div id="layoutSidenav">
        <!-- sidenav -->
        <%- include('../layout/sidenav.ejs') -%>
        <div id="layoutSidenav_content">
            <main>
                <div class="container-fluid px-4">
                    <div class="d-flex justify-content-between align-items-center mt-4 mb-1">
                        <div class="d-flex flex-column w-100">
                            <h1 class="fw-bold text-primary mb-1"><i class="fas fa-wallet"></i> Crypto Wallet</h1>
                            <ol class="breadcrumb bg-light rounded shadow-sm px-3 py-2 mt-2" style="cursor: pointer;">
                                <li class="breadcrumb-item"><a href="/admin" class="text-decoration-none">Dashboard</a></li>
                                <li class="breadcrumb-item active">Crypto Wallet</li>
                            </ol>
                        </div>
                        <a href="/admin/crypto-wallet/export" class="btn btn-primary">
                            <i class="fas fa-download"></i> Export CSV
                        </a>
                    </div>

                    <% if (error) { %>
                        <div id="error-alert" class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fa fa-exclamation-circle me-2"></i> <%= error %>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    <% } %>

                    <!-- Wallet Info Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <i class="fas fa-wallet me-2"></i>Wallet Info
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-xl-6">
                                    <div class="mb-3">
                                        <h6 class="text-muted mb-1">Wallet Balance</h6>
                                        <h3 class="text-primary"><%= balanceInSGB %> <small>SGB</small></h3>
                                    </div>
                                </div>
                                <div class="col-xl-6">
                                    <div class="mb-3">
                                        <h6 class="text-muted mb-1">Wallet Address</h6>
                                        <p class="text-monospace mb-0" 
                                            style="font-family: monospace; word-break: break-all; font-size: 12px; color: red; font-weight: bold;">
                                                <%= walletAddress %>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Statistics -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <div class="text-muted small mb-1"><i class="fas fa-exchange-alt me-1"></i>Total Transactions</div>
                                    <h3 class="text-primary"><%= totalTransactions %></h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <div class="text-muted small mb-1"><i class="fas fa-coins me-1"></i>Total Received (SGB)</div>
                                    <h3 class="text-primary"><%= totalReceivedSGB %></h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <div class="text-muted small mb-1"><i class="fas fa-money-bill me-1"></i>Total Received (VND)</div>
                                    <h3 class="text-primary"><%= new Intl.NumberFormat('vi-VN').format(totalReceived) %></h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Transactions Table -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div><i class="fas fa-list me-2"></i>Transaction History</div>
                        </div>
                        <div class="card-body">
                            <% if (transactions && transactions.length > 0) { %>
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Order ID</th>
                                                <th>User</th>
                                                <th>Email</th>
                                                <th>Amount</th>
                                                <th>Date</th>
                                                <th>Status</th>
                                                <th>Transaction Hash</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <% transactions.forEach(tx => { %>
                                                <tr data-order-id="<%= tx.orderId %>">
                                                    <td><strong>#<%= tx.orderId %></strong></td>
                                                    <td><%= tx.userName %></td>
                                                    <td><small><%= tx.userEmail %></small></td>
                                                    <td>
                                                        <div class="text-primary fw-bold"><%= tx.amount %> SGB</div>
                                                        <div class="text-muted small"><%= new Intl.NumberFormat('vi-VN').format(tx.vndAmount) %> VND</div>
                                                    </td>
                                                    <td><small><%= tx.createdAt %></small></td>
                                                    <td>
                                                        <% const statusMap = {
                                                            'COMPLETED': { badge: 'success', text: 'Completed' },
                                                                'SUCCESS': { badge: 'success', text: 'Completed' },
                                                                'REFUNDED': { badge: 'info', text: 'Refunded' },
                                                                'PENDING': { badge: 'warning', text: 'Pending' },
                                                                'FAILED': { badge: 'danger', text: 'Failed' }
                                                        };
                                                        const statusInfo = statusMap[tx.status] || { badge: 'secondary', text: tx.status };
                                                        %>
                                                        <span class="badge bg-<%= statusInfo.badge %>">
                                                            <%= statusInfo.text %>
                                                        </span>
                                                    </td>
                                                    <td>
                                                        <small style="font-family: monospace;" title="<%= tx.transactionHash %>">
                                                            <%= tx.transactionHash ? tx.transactionHash.substring(0, 16) + '...' : 'N/A' %>
                                                        </small>
                                                    </td>
                                                    <td>
                                                        <button class="btn btn-sm btn-outline-primary view-details" data-order-id="<%= tx.orderId %>">
                                                            <i class="fas fa-eye"></i> Details
                                                        </button>
                                                    </td>
                                                </tr>
                                                <!-- Detail Row -->
                                                <tr class="detail-row" id="detail-<%= tx.orderId %>" style="display: none;">
                                                    <td colspan="8">
                                                        <div id="detailContent<%= tx.orderId %>" class="p-3">
                                                            <div class="text-center">
                                                                <div class="spinner-border text-primary spinner-border-sm" role="status">
                                                                    <span class="visually-hidden">Loading...</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            <% }); %>
                                        </tbody>
                                    </table>
                                </div>
                            <% } else { %>
                                <div class="text-center p-5">
                                    <i class="fas fa-inbox" style="font-size: 48px; color: #ccc;"></i>
                                    <p class="text-muted mt-3">Chưa có giao dịch nào</p>
                                </div>
                            <% } %>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <%- include('../layout/footer.ejs') -%>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/admin/js/scripts.js"></script>
    <script>
        // Handle detail rows
        document.querySelectorAll('.view-details').forEach(btn => {
            btn.addEventListener('click', async function() {
                const orderId = this.dataset.orderId;
                const detailRow = document.getElementById(`detail-${orderId}`);
                const detailContent = document.getElementById(`detailContent${orderId}`);
                
                // Toggle detail row visibility
                if (detailRow.style.display === 'none') {
                    // Load data if not loaded yet
                    if (detailContent.innerHTML.includes('spinner-border')) {
                        try {
                            const response = await fetch(`/admin/crypto-wallet/transaction/${orderId}`);
                            const data = await response.json();
                            
                            let html = `
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <h6 class="text-primary mb-2"><i class="fas fa-file-invoice me-1"></i>Order Info</h6>
                                        <div class="mb-2">
                                            <strong>Order ID:</strong> #${data.orderId}
                                        </div>
                                        <div class="mb-2">
                                            <strong>Status:</strong> <span class="badge bg-success">${data.payment.status}</span>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Method:</strong> ${data.payment.method}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-primary mb-2"><i class="fas fa-user me-1"></i>User Info</h6>
                                        <div class="mb-2">
                                            <strong>Name:</strong> ${data.user.fullName}
                                        </div>
                                        <div class="mb-2">
                                            <strong>Email:</strong> ${data.user.email}
                                        </div>
                                    </div>
                                </div>
                                
                                <hr>
                                
                                <h6 class="text-primary mb-2"><i class="fas fa-exchange-alt me-1"></i>Transaction Info</h6>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="mb-2">
                                            <strong>Amount:</strong> ${data.payment.sgbAmount} SGB
                                        </div>
                                        <div class="mb-2">
                                            <strong>Equivalent:</strong> ${new Intl.NumberFormat('en-US').format(data.payment.totalPrice)} VND
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-2">
                                            <strong>Transaction Hash:</strong><br>
                                            <code style="word-break: break-all; font-size: 11px;">${data.payment.transactionHash || 'N/A'}</code>
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <strong>Created At:</strong> ${new Date(data.createdAt).toLocaleString('en-US')}
                                </div>
                                
                                <hr>
                                
                                <h6 class="text-primary mb-2"><i class="fas fa-truck me-1"></i>Receiver Info</h6>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="mb-2">
                                            <strong>Name:</strong> ${data.receiver.name}
                                        </div>
                                        <div class="mb-2">
                                            <strong>Phone:</strong> ${data.receiver.phone}
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-2">
                                            <strong>Email:</strong> ${data.receiver.email}
                                        </div>
                                        <div class="mb-2">
                                            <strong>Note:</strong> ${data.receiver.note || 'None'}
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <strong>Address:</strong> ${data.receiver.address}
                                </div>
                                
                                <hr>
                                
                                <h6 class="text-primary mb-2"><i class="fas fa-box me-1"></i>Product Details</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Product</th>
                                                <th>Quantity</th>
                                                <th>Price</th>
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                            `;
                            
                            data.orderDetails.forEach(item => {
                                const total = item.quantity * item.price;
                                html += `
                                    <tr>
                                        <td>${item.productName || 'N/A'}</td>
                                        <td>${item.quantity}</td>
                                        <td>${new Intl.NumberFormat('vi-VN').format(item.price)}</td>
                                        <td><strong>${new Intl.NumberFormat('vi-VN').format(total)}</strong></td>
                                    </tr>
                                `;
                            });
                            
                            html += `
                                        </tbody>
                                    </table>
                                </div>
                            `;
                            
                            detailContent.innerHTML = html;
                        } catch (error) {
                            console.error('Error loading details:', error);
                            detailContent.innerHTML = '<div class="alert alert-danger mb-0">Có lỗi khi tải thông tin chi tiết</div>';
                        }
                    }
                    detailRow.style.display = 'table-row';
                    this.innerHTML = '<i class="fas fa-chevron-up"></i> Ẩn';
                } else {
                    detailRow.style.display = 'none';
                    this.innerHTML = '<i class="fas fa-eye"></i> Chi Tiết';
                }
            });
        });
    </script>
</body>

</html>
