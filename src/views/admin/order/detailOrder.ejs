<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="LianHarman - Dự án laptopshop" />
    <meta name="author" content="LianHarman" />
    <title>View Order Detail - LianHarman</title>
    <link rel="icon" type="image/svg+xml" href="/im/Logo-Admin.svg">
    <link href="/admin/css/styles.css" rel="stylesheet" />
    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script>
        $(document).ready(() => {
            const imageFile = $("#imageFile");
            imageFile.change(function (e) {
                const imgURL = URL.createObjectURL(e.target.files[0]);
                $("#imageFilePreview").attr("src", imgURL);
                $("#imageFilePreview").css({ "display": "block" });
            });
        });
    </script>
</head>

<body class="sb-nav-fixed">
    <!-- header -->
    <%- include('../layout/header.ejs') -%>

        <!-- main content -->
        <div id="layoutSidenav">
            <!-- sidenav -->
            <%- include('../layout/sidenav.ejs') -%>
                <div id="layoutSidenav_content">
                    <main>
                        <div class="container-fluid px-4">                            
                            <div class="d-flex justify-content-between align-items-center mt-4 mb-1">
                                <div class="d-flex flex-column w-100">
                                    <h1 class="fw-bold text-primary mb-1"><i class="fa-solid fa-file-invoice"></i> Order Detail</h1>
                                    <ol class="breadcrumb bg-light rounded shadow-sm px-3 py-2 mt-2" style="cursor: pointer;">
                                        <li class="breadcrumb-item"><a href="/admin" class="text-decoration-none"><i class="fas fa-home me-1"></i> Dashboard</a></li>
                                        <li class="breadcrumb-item"><a href="/admin/order" class="text-decoration-none">Orders</a></li>
                                        <li class="breadcrumb-item active">Order Detail</li>
                                    </ol>
                                </div>
                            </div>
                            <% if (typeof success !== 'undefined' && success) { %>
                                <div id="order-success-alert" class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                                    <i class="fa fa-check-circle me-2"></i> Cập nhật đơn hàng thành công!
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            <% } %>
                            <form action="/admin/UpdateOrderById/<%= order.id %>" method="POST">
                                <% if (order) { %>
                                <div class="card shadow border-0 mb-4">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0"><i class="fa-solid fa-receipt"></i> Order ID: <%= order.id %></h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <div class="mb-2">
                                                    <label class="form-label fw-bold">User ID</label>
                                                    <input type="text" class="form-control form-control-sm" value="<%= order.User.id %>" readonly disabled>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label fw-bold">User Name</label>
                                                    <input type="text" class="form-control form-control-sm" value="<%= order.User.fullName %>" readonly disabled>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label fw-bold">Payment Method</label>
                                                    <input type="text" class="form-control form-control-sm" value="<%= order.paymentMethod %>" readonly disabled>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label fw-bold">Payment Status</label>
                                                    <input type="text" class="form-control form-control-sm" value="<%= order.paymentStatus %>" readonly disabled>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label fw-bold text-info">Order Status</label>
                                                    <select name="statusOrder" class="form-select form-select-sm">
                                                        <option value="PENDING" <%=order.statusOrder==='PENDING' ? 'selected' : '' %>>PENDING</option>
                                                        <option value="PROCESSING" <%=order.statusOrder==='PROCESSING' ? 'selected' : '' %>>PROCESSING</option>
                                                        <option value="CONFIRMED" <%=order.statusOrder==='CONFIRMED' ? 'selected' : '' %>>CONFIRMED</option>
                                                        <option value="PACKED" <%=order.statusOrder==='PACKED' ? 'selected' : '' %>>PACKED</option>
                                                        <option value="SHIPPED" <%=order.statusOrder==='SHIPPED' ? 'selected' : '' %>>SHIPPED</option>
                                                        <option value="DELIVERED" <%=order.statusOrder==='DELIVERED' ? 'selected' : '' %>>DELIVERED</option>
                                                        <option value="CANCELLED" <%=order.statusOrder==='CANCELLED' ? 'selected' : '' %>>CANCELLED</option>
                                                        <option value="RETURNED" <%=order.statusOrder==='RETURNED' ? 'selected' : '' %>>RETURNED</option>
                                                        <option value="REFUNDED" <%=order.statusOrder==='REFUNDED' ? 'selected' : '' %>>REFUNDED</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-2">
                                                    <label class="form-label fw-bold">Receiver Name</label>
                                                    <input type="text" class="form-control form-control-sm" value="<%= order.receiverName %>" name="receiverName" required>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label fw-bold">Receiver Address</label>
                                                    <input type="text" class="form-control form-control-sm" value="<%= order.receiverAddress %>" name="receiverAddress" required>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label fw-bold">Receiver Phone</label>
                                                    <input type="text" class="form-control form-control-sm" value="<%= order.receiverPhone %>" name="receiverPhone" required>
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label fw-bold">Receiver Email</label>
                                                    <input type="text" class="form-control form-control-sm" value="<%= order.receiverEmail ? order.receiverEmail : 'Null' %>" name="receiverEmail">
                                                </div>
                                                <div class="mb-2">
                                                    <label class="form-label fw-bold">Receiver Note</label>
                                                    <input type="text" class="form-control form-control-sm" value="<%= order.receiverNote %>" name="receiverNote">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <% } %>

                            <div class="card shadow border-0 mb-4">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0"><i class="fa-solid fa-box"></i> Order Items</h5>
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover align-middle mb-0 text-center">
                                            <thead class="table-light">
                                                <tr>
                                                    <th scope="col">Product</th>
                                                    <th scope="col">Name</th>
                                                    <th scope="col">Configuration</th>
                                                    <th scope="col">Price</th>
                                                    <th scope="col">Quantity</th>
                                                    <th scope="col">Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <% if (detailOrder && detailOrder.length > 0) { %>
                                                    <% detailOrder.forEach((item, index) => { %>
                                                        <tr>
                                                            <td>
                                                                <img src="<%= item.product.image ? '/images/products/' + item.product.image : '/client/img/default-product.png' %>" class="img-fluid rounded-circle border" style="width: 80px; height: 80px; min-width: 50px; min-height: 50px; object-fit: cover;" alt="image product <%= item.product.name %>">
                                                                <input type="hidden" name="detailOrder[<%= index %>][id]" value="<%= item.id %>" />
                                                            </td>
                                                            <td>
                                                                <a href="/product/<%= item.product.id %>" class="text-decoration-none fw-bold text-primary">
                                                                    <%= item.product.name %>
                                                                </a>
                                                            </td>
                                                            <td>
                                                                <% if (item.productVariant && item.productVariant.id) { %>
                                                                    <div class="d-flex justify-content-center align-items-center w-100">
                                                                        <span class="badge bg-info text-dark fs-5 px-4 py-2" style="font-size: 0.8rem !important;">
                                                                            <%= item.productVariant.cpu %> | <%= item.productVariant.memory %> | <%= item.productVariant.color %>
                                                                        </span>
                                                                    </div>
                                                                <% } else { %>
                                                                    <span class="text-muted">Không có</span>
                                                                <% } %>
                                                            </td>
                                                            <td>
                                                                <span class="fw-bold text-warning"><%= (item.product.price + item.productVariant.priceMore).toLocaleString('vi-VN') %> VND</span>
                                                            </td>
                                                            <td>
                                                                <div class="input-group quantity d-flex align-items-center justify-content-center" style="width: 120px;">
                                                                    <button type="button" class="btn btn-sm btn-minus rounded-circle bg-light border"><i class="fa fa-minus"></i></button>
                                                                    <input type="number" name="detailOrder[<%= index %>][quantity]" min="1" max="<%= item.product.quantity %>" class="form-control form-control-sm text-center border-0 mx-1" value="<%= item.quantity %>" style="width: 40px; min-width: 40px;" data-InputCartDetail-id="<%= item.id %>" data-InputCartDetail-price="<%= item.product.price %>" data-InputCartDetail-priceMore="<%= item.productVariant ? item.productVariant.priceMore : 0 %>" data-InputQuantityCartDetail-index="<%= index %>">
                                                                    <button type="button" class="btn btn-sm btn-plus rounded-circle bg-light border"><i class="fa fa-plus"></i></button>
                                                                </div>
                                                            </td>
                                                            <td>
                                                                <span class="fw-bold text-danger" data-OutPutCartDetail-id="<%= item.id %>">
                                                                    <%= (item.price * item.quantity).toLocaleString('vi-VN') %> VND
                                                                </span>
                                                                <% if (String(order.paymentMethod || '').toUpperCase() === 'CRYPTO' && cryptoTx && cryptoTx.cryptocurrency) { %>
                                                                    <% 
                                                                        const cryptoPriceVnd = Number(cryptoTx.cryptocurrency.priceVND) || 0;
                                                                        const cryptoDecimals = typeof cryptoTx.cryptocurrency.decimals !== 'undefined' ? Number(cryptoTx.cryptocurrency.decimals) : 8;
                                                                        const cryptoSymbol = cryptoTx.cryptocurrency.symbol || cryptoTx.cryptocurrency.code || '';
                                                                        const lineVnd = Number(item.price) * Number(item.quantity || 0);
                                                                        const lineCrypto = cryptoPriceVnd ? (lineVnd / cryptoPriceVnd) : 0;
                                                                        const displayDecimals = Math.min(8, Math.max(0, cryptoDecimals || 8));
                                                                    %>
                                                                    <p id="crypto-display-<%= item.id %>" class="mb-0 text-muted small">~ <%= Number(lineCrypto).toFixed(displayDecimals) %> <%= cryptoSymbol %></p>
                                                                <% } %>
                                                            </td>
                                                        </tr>
                                                    <% }); %>
                                                <% } else { %>
                                                    <tr>
                                                        <td colspan="6" class="text-center">Empty product</td>
                                                    </tr>
                                                <% } %>
                                            </tbody>
                                            <tfoot>
                                                <tr>
                                                    <th colspan="4" class="text-end">Total:</th>
                                                    <th>
                                                        <input id="total-quantity" name="totalQuantity" type="number" readonly tabindex="-1" class="form-control-plaintext text-center fw-bold" style="width:50px; pointer-events:none;" />
                                                    </th>
                                                    <th>
                                                        <input id="total-price" name="totalPrice" type="text" readonly tabindex="-1" class="form-control-plaintext text-center fw-bold text-danger" style="width:160px; pointer-events:none;" />
                                                    </th>
                                                </tr>
                                                <% if (String(order.paymentMethod || '').toUpperCase() === 'CRYPTO' && cryptoTx && cryptoTx.cryptocurrency) { %>
                                                    <tr>
                                                        <th colspan="5" class="text-end">Crypto Total:</th>
                                                            <th class="text-center text-muted">
                                                            <% 
                                                                const cryptoSymbol = cryptoTx.cryptocurrency.symbol || cryptoTx.cryptocurrency.code || '';
                                                                // If the crypto transaction stored the amount, prefer that; otherwise compute from order.totalPrice and priceVND
                                                                const cryptoAmountDisplay = cryptoTx.amount && String(cryptoTx.amount).trim() !== '' ? cryptoTx.amount : (Number(order.totalPrice || 0) / (Number(cryptoTx.cryptocurrency.priceVND) || 1));
                                                                const cryptoDecimals = typeof cryptoTx.cryptocurrency.decimals !== 'undefined' ? Number(cryptoTx.cryptocurrency.decimals) : 8;
                                                                const displayDecimals = Math.min(8, Math.max(0, cryptoDecimals || 8));
                                                            %>
                                                            <span id="crypto-total">~ <%= Number(cryptoAmountDisplay || 0).toFixed(displayDecimals) %> <%= cryptoSymbol %></span>
                                                        </th>
                                                    </tr>
                                                <% } %>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex flex-row mb-3 align-items-center w-100 col-12">
                                <div class="col-md-6 d-flex justify-content-start px-4">
                                    <a href="/admin/order" class="btn btn-success"><i class="fa fa-arrow-left"></i> Back to Order List</a>
                                </div>
                                <div class="col-md-6 d-flex justify-content-end px-4">
                                    <button type="submit" class="btn btn-primary"><i class="fa fa-save"></i> Update</button>
                                </div>
                            </div>
                            </form>
                        </div>
                    </main>
                    <!-- footer -->
                    <%- include('../layout/footer.ejs') -%>
                </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
            crossorigin="anonymous"></script>
        <script src="/admin/js/scripts.js"></script>
        <% if (cryptoTx && cryptoTx.cryptocurrency) { %>
        <script>
            (function(){
                try {
                    const orderCrypto = <%- JSON.stringify({ priceVND: cryptoTx.cryptocurrency.priceVND, decimals: cryptoTx.cryptocurrency.decimals, symbol: cryptoTx.cryptocurrency.symbol || cryptoTx.cryptocurrency.code, amount: cryptoTx.amount || null }) %>;
                    const paymentMethod = "<%= (order && order.paymentMethod) ? String(order.paymentMethod).toUpperCase() : '' %>";
                    if (!orderCrypto || paymentMethod !== 'CRYPTO') return;

                    function formatCrypto(amount, decimals){
                        if (amount === null || amount === undefined || isNaN(Number(amount))) return '0';
                        const d = Math.min(8, Math.max(0, Number(decimals) || 8));
                        return Number(amount).toFixed(d);
                    }

                    function computeAndUpdateCrypto(){
                        const inputs = Array.from(document.querySelectorAll('input[data-InputCartDetail-id]'));
                        let sumCrypto = 0;
                        inputs.forEach(inp => {
                            const id = inp.getAttribute('data-InputCartDetail-id');
                            const price = Number(inp.getAttribute('data-InputCartDetail-price')) || 0;
                            const priceMore = Number(inp.getAttribute('data-InputCartDetail-priceMore')) || 0;
                            const qty = Number(inp.value) || 0;
                            const lineVnd = qty * (price + priceMore);
                            const lineCrypto = orderCrypto.priceVND ? (lineVnd / Number(orderCrypto.priceVND)) : 0;
                            sumCrypto += lineCrypto;
                            const el = document.getElementById('crypto-display-' + id);
                            if (el) el.textContent = '~ ' + formatCrypto(lineCrypto, orderCrypto.decimals) + ' ' + (orderCrypto.symbol || '');
                        });
                        const totalEl = document.getElementById('crypto-total');
                        if (totalEl) totalEl.textContent = '~ ' + formatCrypto(sumCrypto, orderCrypto.decimals) + ' ' + (orderCrypto.symbol || '');
                    }

                    // attach listeners
                    document.querySelectorAll('input[data-InputCartDetail-id]').forEach(inp => {
                        inp.addEventListener('input', computeAndUpdateCrypto);
                        inp.addEventListener('change', computeAndUpdateCrypto);
                    });

                    // run once on load
                    computeAndUpdateCrypto();
                } catch (err) {
                    console.error('crypto dynamic update error', err);
                }
            })();
        </script>
        <% } %>
</body>

</html>