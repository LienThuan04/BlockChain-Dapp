<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>My Cart - laptopshop</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">
    <link rel="icon" type="image/svg+xml" href="/im/Logo-Client.svg">


    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Raleway:wght@600;800&display=swap"
        rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="/client/lib/lightbox/css/lightbox.min.css" rel="stylesheet">
    <link href="/client/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">


    <!-- Customized Bootstrap Stylesheet -->
    <link href="/client/css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="/client/css/style.css" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.css" integrity="sha512-wJgJNTBBkLit7ymC6vvzM1EcSWeM9mmOu+1USHaRBbHkm6W9EgM0HY27+UtUaprntaYQJF75rc8gjxllKs5OIQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>

<body>

    <!-- Spinner Start -->
    <div id="spinner"
        class="show w-100 vh-100 bg-white position-fixed translate-middle top-50 start-50  d-flex align-items-center justify-content-center">
        <div class="spinner-grow text-primary" role="status"></div>
    </div>
    <!-- Spinner End -->


    <!-- Navbar start -->
    <%- include('../layout/header.ejs') -%>
        <!-- Navbar End -->
        <div class="py-4"></div>

        <!-- Single Product Start -->
        <div class="container-fluid page-header py-5">
            <h1 class="text-center text-white display-6">Giỏ hàng của tôi</h1>
            <ol class="breadcrumb justify-content-center mb-0">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="/cart">Giỏ hàng</a></li>
                <li class="breadcrumb-item active text-white">Thanh toán</li>
            </ol>
        </div>
        <!-- Single Page Header End -->


        <!-- Cart Page Start -->
        <div class="container-fluid py-5">
            <div class="container py-5">
                <div class="table-responsive">
                    <table class="table text-center">
                        <thead>
                            <tr>
                                <th scope="col">Sản phẩm</th>
                                <th scope="col">Tên</th>
                                <th scope="col">Cấu hình</th>
                                <th scope="col">Giá</th>
                                <th scope="col">Số lượng</th>
                                <th scope="col">Tổng cộng</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (cartDetails && cartDetails.length > 0 && cartDetails.some(item => item.isSelected)) { %>
                                <% cartDetails.forEach(function(item) { %>
                                    <% if (item.isSelected) { %>
                                    <tr class="detailCartId:<%= item.id %>">
                                        <th scope="row">
                                            <div class="d-flex align-items-center justify-content-center">
                                                <img src="<%= item.product.image ? '/images/products/' + item.product.image : '/client/img/default-product.png' %>"
                                                    class="img-fluid me-5 rounded-circle"
                                                    style="width: 80px; height: 80px; min-width: 50px; min-height: 50px;"
                                                    alt="image product <%= item.product.name %>">
                                            </div>
                                        </th>
                                        <td>
                                            <p class="mb-0 mt-4 text-primary">
                                                <a href="/product/<%= item.product.id %>"
                                                    class="text-decoration-none fw-bold">
                                                    <%= item.product.name %>
                                                </a>
                                            </p>
                                        </td>
                                        <td>
                                            <% if (item.product.productVariants && item.product.productVariants.length > 0) { %>
                                                <% const selectedVariant = item.product.productVariants.find(v => v.id == item.productVariantId) || item.product.productVariants[0]; %>
                                                <div class="d-flex justify-content-center align-items-center mt-4 w-100">
                                                    <span class="badge bg-info text-dark fs-5 px-4 py-2" style="font-size: 1.15rem !important;">
                                                        <%= selectedVariant.cpu %> | <%= selectedVariant.memory %> | <%= selectedVariant.color %>
                                                    </span>
                                                </div>
                                            <% } else { %>
                                                <span class="text-muted">Không có</span>
                                            <% } %>
                                        </td>
                                        <td>
                                            <p class="mb-0 mt-4 text-warning">
                                                <% 
                                                    let variantPrice = 0;
                                                    if (item.product.productVariants && item.product.productVariants.length > 0) {
                                                        const selectedVariant = item.product.productVariants.find(v => v.id == item.productVariantId) || item.product.productVariants[0];
                                                        variantPrice = Number(selectedVariant && selectedVariant.priceMore ? selectedVariant.priceMore : 0);
                                                    }
                                                    const totalUnitPrice = Number(item.product.price) + variantPrice;
                                                %>
                                                <%= totalUnitPrice.toLocaleString('vi-VN') %> VND
                                            </p>
                                        </td>
                                        <td>
                                            <div class="input-group quantity mt-4 d-flex align-items-center"
                                                style="width: auto;">
                                                <input type="number" name="quantityProduct" min="1"
                                                    max="<%= item.product.quantity %>"
                                                    class="form-control form-control-sm text-center border-0"
                                                    value="<%= item.quantityProduct %>"
                                                    style="width: 15px; min-width: 15px;"
                                                    data-InputCartDetail-id="<%= item.id %>"
                                                    data-InputCartDetail-price="<%= item.product.price %>" disabled>
                                            </div>
                                        </td>
                                        <td>
                                            <p class="mb-0 mt-4 text-danger" data-OutPutCartDetail-id="<%= item.id %>">
                                                <%
                                                    var totalLineRow = (Number(item.product.price) + variantPrice) * item.quantityProduct;
                                                %>
                                                <%= totalLineRow.toLocaleString('vi-VN') %> VND
                                            </p>
                                        </td>
                                    </tr>
                                    <% } %>
                                <% }); %>
                            <% } else { %>
                                <tr>
                                    <td colspan="6" class="text-center">Giỏ hàng trống</td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
                <% if (cartDetails && cartDetails.length> 0) { %>
                    <form action="/place-order" method="POST">
                        <div class="mt-5 row g-4 justify-content-end">
                            <div class="col-12 col-md-6">
                                <div
                                    class="bg-light rounded shadow-sm h-100 p-4 d-flex flex-column justify-content-center">
                                    <h4 class="mb-4 text-center text-uppercase fw-bold text-primary">Thông tin người
                                        nhận</h4>
                                    <div class="row g-3">
                                        <div class="col-12">
                                            <label for="receiverName" class="form-label">Họ và tên người nhận</label>
                                            <input type="text" class="form-control" id="receiverName"
                                                name="receiverName" required placeholder="Nhập họ và tên" required>
                                        </div>
                                        <div class="col-12">
                                            <label for="receiverPhone" class="form-label">Số điện thoại</label>
                                            <input type="tel" class="form-control" id="receiverPhone"
                                                name="receiverPhone" required placeholder="Nhập số điện thoại" required>
                                        </div>
                                        <div class="col-12">
                                            <label for="receiverAddress" class="form-label">Địa chỉ nhận hàng</label>
                                            <input type="text" class="form-control" id="receiverAddress"
                                                name="receiverAddress" required placeholder="Nhập địa chỉ" required>
                                        </div>
                                        <div class="col-12">
                                            <label for="receiverEmail" class="form-label">Email (nếu có)</label>
                                            <input type="email" class="form-control" id="receiverEmail"
                                                name="receiverEmail" placeholder="Nhập email">
                                        </div>
                                        <div class="col-12">
                                            <label for="receiverNote" class="form-label">Ghi chú</label>
                                            <textarea class="form-control" id="receiverNote" name="receiverNote"
                                                rows="2" placeholder="Ghi chú thêm (nếu có)"></textarea>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-center mt-4">
                                        <a href="/cart"
                                            class="btn btn-outline-primary rounded-pill px-4 py-2 text-uppercase">
                                            <i class="bi bi-arrow-left"></i> Quay lại giỏ hàng
                                        </a>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12 col-md-6">
                                <div class="bg-light rounded shadow-sm h-100 p-4">
                                    <h4 class="mb-4 text-center text-uppercase fw-bold text-primary">Thông tin thanh
                                        toán</h4>
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="fw-bold">Tạm tính:</span>
                                            <span class="text-primary fw-bold" data-TotalPrice="<%= TotalPrice %>">
                                                <%= TotalPrice.toLocaleString('vi-VN') %> VND
                                            </span>
                                        </div>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="fw-bold">Phí vận chuyển:</span>
                                            <span>
                                                <%= (TotalPrice> 0 ? 0 : 0).toLocaleString('vi-VN') %> VND / 1KM
                                            </span>
                                        </div>
                                        <div
                                            class="d-flex justify-content-between align-items-center border-top pt-3 mt-3">
                                            <span class="fs-5 fw-bold text-danger">Tổng cộng:</span>
                                            <span class="fs-5 fw-bold text-danger"
                                                data-TotalPriceTT="<%= TotalPrice %>">
                                                <%= (TotalPrice).toLocaleString('vi-VN') %> VND
                                            </span>
                                        </div>
                                        <!-- Crypto total (shown when user selects CRYPTO) -->
                                        <div id="cryptoPriceRow" class="d-flex justify-content-between align-items-center mt-2"
                                            style="<%= (typeof cryptoTotal !== 'undefined' && cryptoActive) ? 'display:flex;' : 'display:none;' %>">
                                            <span class="fw-bold">Tổng cộng (SGB):</span>
                                            <span class="text-primary fw-bold" id="cryptoAmountDisplay">
                                                <%= (typeof cryptoTotal !== 'undefined' && cryptoTotal) ? cryptoTotal : '0' %> SGB
                                            </span>
                                        </div>
                                        <div id="cryptoRateRow" class="d-flex justify-content-between align-items-center small text-muted mt-1"
                                            style="<%= cryptoActive ? 'display:flex;' : 'display:none;' %>">
                                            <span>Tỷ giá:</span>
                                            <span id="cryptoRateDisplay"><%= cryptoActive ? (cryptoActive.priceVND ? Number(cryptoActive.priceVND).toLocaleString('vi-VN') : '') : '' %> VND / 1 SGB</span>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="fw-bold mb-2">Hình thức thanh toán</label>
                                        <div class="list-group">
                                            <label
                                                class="list-group-item d-flex align-items-center justify-content-between">
                                                <span>
                                                    <input class="form-check-input me-2" type="radio"
                                                        name="paymentMethod" value="COD" checked>
                                                    <i class="fas fa-truck text-warning me-2"></i>
                                                    Thanh toán khi nhận hàng
                                                </span>
                                            </label>
                                            <label
                                                class="list-group-item d-flex align-items-center justify-content-between">
                                                <span>
                                                    <input class="form-check-input me-2" type="radio"
                                                        name="paymentMethod" value="BANK">
                                                    <i class="fas fa-university text-primary me-2"></i>
                                                    Thanh toán bằng ngân hàng
                                                </span>
                                            </label>
                                            <label
                                                class="list-group-item d-flex align-items-center justify-content-between">
                                                <span>
                                                    <input class="form-check-input me-2" type="radio"
                                                        name="paymentMethod" value="TRANSFER">
                                                    <i class="fas fa-exchange-alt text-success me-2"></i>
                                                    Chuyển khoản
                                                </span>
                                            </label>
                                            <label
                                                class="list-group-item d-flex align-items-center justify-content-between">
                                                <span>
                                                    <input class="form-check-input me-2" type="radio"
                                                        name="paymentMethod" value="PAYPAL">
                                                    <img src="https://www.paypalobjects.com/webstatic/icon/pp258.png"
                                                        alt="PayPal"
                                                        style="height:24px;vertical-align:middle;margin-right:6px;">
                                                    Thanh toán qua PayPal
                                                </span>
                                            </label>
                                            <label
                                                class="list-group-item d-flex align-items-center justify-content-between">
                                                <span>
                                                    <input class="form-check-input me-2" type="radio"
                                                        name="paymentMethod" value="CRYPTO">
                                                    <i class="fab fa-bitcoin text-warning me-2"></i>
                                                    Thanh toán bằng tiền ảo
                                                </span>
                                            </label>
                                        </div>
                                    </div>
                                    <input type="hidden" name="totalPrice" value="<%= TotalPrice %>">
                                    <% if (cartDetails && cartDetails.length > 0 && cartDetails.some(item => item.isSelected)) { %>
                                        <% cartDetails.forEach(function(item, index) { %>
                                            <% if (item.isSelected) { %>
                                                <input type="hidden" name="ListIdDetailCartPay[<%= index %>][id]" value="<%= item.id %>">
                                                <input type="hidden" name="ListIdDetailCartPay[<%= index %>][productVariantId]" value="<%= item.selectedVariantId %>">
                                            <% } %>
                                        <% }); %>
                                    <% } %>
                                    <button class="btn btn-primary rounded-pill px-4 py-3 text-uppercase w-100 mt-3"
                                        type="submit" id="btnCheckoutPay">Tiến hành thanh toán
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                    <% } else{ %>
                        <div class="alert alert-warning" role="alert">
                            Bạn chưa chọn sản phẩm nào để thanh toán.
                        </div>
                        <% } %>
            </div>
        </div>

        <!-- Footer Start -->
        <%- include('../layout/footer.ejs') -%>
            <!-- Footer End -->




            <!-- Back to Top -->
            <a href="#" class="btn btn-primary border-3 border-primary rounded-circle back-to-top"><i
                    class="fa fa-arrow-up"></i></a>


            <!-- JavaScript Libraries -->
            <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>
            <script src="/client/lib/easing/easing.min.js"></script>
            <script src="/client/lib/waypoints/waypoints.min.js"></script>
            <script src="/client/lib/lightbox/js/lightbox.min.js"></script>
            <script src="/client/lib/owlcarousel/owl.carousel.min.js"></script>

            <!-- Template Javascript -->
            <script src="/client/js/main.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-toast-plugin/1.3.2/jquery.toast.min.js" integrity="sha512-zlWWyZq71UMApAjih4WkaRpikgY9Bz1oXIW5G0fED4vk14JjGlQ1UmkGM392jEULP8jbNMiwLWdM8Z87Hu88Fw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
            
            <!-- Web3.js for Crypto Payment -->
            <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
            
            <!-- Crypto Payment Script -->
            <script src="/client/js/crypto-payment.js"></script>
            
            <!-- Modal for Crypto Payment -->
            <div class="modal fade" id="cryptoModal" tabindex="-1" role="dialog" aria-labelledby="cryptoModalLabel" aria-hidden="true" data-bs-backdrop="false">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="cryptoModalLabel">Thanh toán bằng tiền ảo</h5>
                        </div>
                        <div class="modal-body">
                            <div id="cryptoMessage"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Modal to prompt MetaMask install when user doesn't have it -->
            <div class="modal fade" id="installMetamaskModal" tabindex="-1" role="dialog" aria-labelledby="installMetamaskLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="installMetamaskLabel">Cần cài Metamask</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <p>Để thanh toán bằng tiền ảo bạn cần cài đặt MetaMask (ví trình duyệt). Bạn có thể cài đặt MetaMask ngay bây giờ hoặc quay lại để chọn phương thức thanh toán khác.</p>
                        </div>
                        <div class="modal-footer">
                            <a id="installMetaMaskBtn" class="btn btn-primary" target="_blank" rel="noopener" href="https://metamask.io/download.html">Cài MetaMask</a>
                            <button type="button" id="stayChooseOtherBtn" class="btn btn-secondary" data-bs-dismiss="modal">Ở lại, chọn phương thức khác</button>
                        </div>
                    </div>
                </div>
            </div>

            <script>
                // Wire install modal buttons: stay button simply closes modal (data-bs-dismiss handles it).
                document.addEventListener('DOMContentLoaded', function () {
                    const stayBtn = document.getElementById('stayChooseOtherBtn');
                    if (stayBtn) {
                        stayBtn.addEventListener('click', function () {
                            try {
                                // Optionally, uncheck Crypto radio so user can pick another method
                                const cryptoRadio = document.querySelector('input[name="paymentMethod"][value="CRYPTO"]');
                                if (cryptoRadio) cryptoRadio.checked = false;
                                // Enable checkout button if it was disabled
                                const btn = document.getElementById('btnCheckoutPay');
                                if (btn) { btn.disabled = false; btn.innerText = 'Tiến hành thanh toán'; }
                            } catch (e) {
                                console.warn('Error handling stay button:', e);
                            }
                        });
                    }
                });
                
                // Show/hide crypto total when payment method changes
                document.addEventListener('DOMContentLoaded', function () {
                    try {
                        const cryptoRow = document.getElementById('cryptoPriceRow');
                        const cryptoRateRow = document.getElementById('cryptoRateRow');
                        const radios = document.querySelectorAll('input[name="paymentMethod"]');
                        function update() {
                            const sel = document.querySelector('input[name="paymentMethod"]:checked');
                            const isCrypto = sel && sel.value === 'CRYPTO';
                            if (cryptoRow) cryptoRow.style.display = isCrypto ? 'flex' : 'none';
                            if (cryptoRateRow) cryptoRateRow.style.display = isCrypto ? 'flex' : 'none';
                        }
                        update();
                        radios.forEach(r => r.addEventListener('change', update));
                    } catch (e) {
                        console.warn('Error initializing crypto toggle', e);
                    }
                });
            </script>
</body>

</html>